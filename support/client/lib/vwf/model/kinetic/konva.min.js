(function(global){"use strict";var PI_OVER_180=Math.PI/180;var Konva={version:"0.15.0",stages:[],idCounter:0,ids:{},names:{},shapes:{},listenClickTap:false,inDblClickWindow:false,enableTrace:false,traceArrMax:100,dblClickWindow:400,pixelRatio:undefined,dragDistance:0,angleDeg:true,showWarnings:true,Filters:{},isDragging:function(){var dd=Konva.DD;if(dd){return dd.isDragging}return false},isDragReady:function(){var dd=Konva.DD;if(dd){return!!dd.node}return false},_addId:function(node,id){if(id!==undefined){this.ids[id]=node}},_removeId:function(id){if(id!==undefined){delete this.ids[id]}},_addName:function(node,name){if(name){if(!this.names[name]){this.names[name]=[]}this.names[name].push(node)}},_removeName:function(name,_id){if(!name){return}var nodes=this.names[name];if(!nodes){return}for(var n=0;n<nodes.length;n++){var no=nodes[n];if(no._id===_id){nodes.splice(n,1)}}if(nodes.length===0){delete this.names[name]}},getAngle:function(angle){return this.angleDeg?angle*PI_OVER_180:angle},_detectIE:function(ua){var msie=ua.indexOf("msie ");if(msie>0){return parseInt(ua.substring(msie+5,ua.indexOf(".",msie)),10)}var trident=ua.indexOf("trident/");if(trident>0){var rv=ua.indexOf("rv:");return parseInt(ua.substring(rv+3,ua.indexOf(".",rv)),10)}var edge=ua.indexOf("edge/");if(edge>0){return parseInt(ua.substring(edge+5,ua.indexOf(".",edge)),10)}return false},_parseUA:function(userAgent){var ua=userAgent.toLowerCase(),match=/(chrome)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||ua.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)||[],mobile=!!userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i),ieMobile=!!userAgent.match(/IEMobile/i);return{browser:match[1]||"",version:match[2]||"0",isIE:Konva._detectIE(ua),mobile:mobile,ieMobile:ieMobile}},UA:undefined};var glob=typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof WorkerGlobalScope!=="undefined"?self:{};Konva.UA=Konva._parseUA(glob.navigator&&glob.navigator.userAgent||"");if(glob.Konva){console.error("Konva instance is already exist in current eviroment. "+"Please use only one instance.")}glob.Konva=Konva;Konva.global=glob;if(typeof exports==="object"){if(glob.window&&glob.window.document){Konva.document=glob.window.document;Konva.window=glob.window}else{var Canvas=require("canvas");var jsdom=require("jsdom").jsdom;Konva.window=jsdom("<!DOCTYPE html><html><head></head><body></body></html>").defaultView;Konva.document=Konva.window.document;Konva.window.Image=Canvas.Image;Konva._nodeCanvas=Canvas}module.exports=Konva;return}else if(typeof define==="function"&&define.amd){define(function(){return Konva})}Konva.document=document;Konva.window=window})(typeof window!=="undefined"?window:global);(function(){"use strict";Konva.Collection=function(){var args=[].slice.call(arguments),length=args.length,i=0;this.length=length;for(;i<length;i++){this[i]=args[i]}return this};Konva.Collection.prototype=[];Konva.Collection.prototype.each=function(func){for(var n=0;n<this.length;n++){func(this[n],n)}};Konva.Collection.prototype.toArray=function(){var arr=[],len=this.length,n;for(n=0;n<len;n++){arr.push(this[n])}return arr};Konva.Collection.toCollection=function(arr){var collection=new Konva.Collection,len=arr.length,n;for(n=0;n<len;n++){collection.push(arr[n])}return collection};Konva.Collection._mapMethod=function(methodName){Konva.Collection.prototype[methodName]=function(){var len=this.length,i;var args=[].slice.call(arguments);for(i=0;i<len;i++){this[i][methodName].apply(this[i],args)}return this}};Konva.Collection.mapMethods=function(constructor){var prot=constructor.prototype;for(var methodName in prot){Konva.Collection._mapMethod(methodName)}};Konva.Transform=function(m){this.m=m&&m.slice()||[1,0,0,1,0,0]};Konva.Transform.prototype={copy:function(){return new Konva.Transform(this.m)},point:function(point){var m=this.m;return{x:m[0]*point.x+m[2]*point.y+m[4],y:m[1]*point.x+m[3]*point.y+m[5]}},translate:function(x,y){this.m[4]+=this.m[0]*x+this.m[2]*y;this.m[5]+=this.m[1]*x+this.m[3]*y;return this},scale:function(sx,sy){this.m[0]*=sx;this.m[1]*=sx;this.m[2]*=sy;this.m[3]*=sy;return this},rotate:function(rad){var c=Math.cos(rad);var s=Math.sin(rad);var m11=this.m[0]*c+this.m[2]*s;var m12=this.m[1]*c+this.m[3]*s;var m21=this.m[0]*-s+this.m[2]*c;var m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;return this},getTranslation:function(){return{x:this.m[4],y:this.m[5]}},skew:function(sx,sy){var m11=this.m[0]+this.m[2]*sy;var m12=this.m[1]+this.m[3]*sy;var m21=this.m[2]+this.m[0]*sx;var m22=this.m[3]+this.m[1]*sx;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;return this},multiply:function(matrix){var m11=this.m[0]*matrix.m[0]+this.m[2]*matrix.m[1];var m12=this.m[1]*matrix.m[0]+this.m[3]*matrix.m[1];var m21=this.m[0]*matrix.m[2]+this.m[2]*matrix.m[3];var m22=this.m[1]*matrix.m[2]+this.m[3]*matrix.m[3];var dx=this.m[0]*matrix.m[4]+this.m[2]*matrix.m[5]+this.m[4];var dy=this.m[1]*matrix.m[4]+this.m[3]*matrix.m[5]+this.m[5];this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;this.m[4]=dx;this.m[5]=dy;return this},invert:function(){var d=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]);var m0=this.m[3]*d;var m1=-this.m[1]*d;var m2=-this.m[2]*d;var m3=this.m[0]*d;var m4=d*(this.m[2]*this.m[5]-this.m[3]*this.m[4]);var m5=d*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=m0;this.m[1]=m1;this.m[2]=m2;this.m[3]=m3;this.m[4]=m4;this.m[5]=m5;return this},getMatrix:function(){return this.m},setAbsolutePosition:function(x,y){var m0=this.m[0],m1=this.m[1],m2=this.m[2],m3=this.m[3],m4=this.m[4],m5=this.m[5],yt=(m0*(y-m5)-m1*(x-m4))/(m0*m3-m1*m2),xt=(x-m4-m2*yt)/m0;return this.translate(xt,yt)}};var CONTEXT_2D="2d",OBJECT_ARRAY="[object Array]",OBJECT_NUMBER="[object Number]",OBJECT_STRING="[object String]",PI_OVER_DEG180=Math.PI/180,DEG180_OVER_PI=180/Math.PI,HASH="#",EMPTY_STRING="",ZERO="0",KONVA_WARNING="Konva warning: ",KONVA_ERROR="Konva error: ",RGB_PAREN="rgb(",COLORS={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],transparent:[255,255,255,0],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]},RGB_REGEX=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;Konva.Util={_isElement:function(obj){return!!(obj&&obj.nodeType==1)},_isFunction:function(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply)},_isObject:function(obj){return!!obj&&obj.constructor===Object},_isArray:function(obj){return Object.prototype.toString.call(obj)===OBJECT_ARRAY},_isNumber:function(obj){return Object.prototype.toString.call(obj)===OBJECT_NUMBER},_isString:function(obj){return Object.prototype.toString.call(obj)===OBJECT_STRING},_throttle:function(func,wait,opts){var context,args,result;var timeout=null;var previous=0;var options=opts||{};var later=function(){previous=options.leading===false?0:(new Date).getTime();timeout=null;result=func.apply(context,args);context=args=null};return function(){var now=(new Date).getTime();if(!previous&&options.leading===false){previous=now}var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args);context=args=null}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result}},_hasMethods:function(obj){var names=[],key;for(key in obj){if(!obj.hasOwnProperty(key)){continue}if(this._isFunction(obj[key])){names.push(key)}}return names.length>0},isValidSelector:function(selector){if(typeof selector!=="string"){return false}var firstChar=selector[0];return firstChar==="#"||firstChar==="."||firstChar===firstChar.toUpperCase()},createCanvasElement:function(){var canvas=Konva.document.createElement("canvas");try{canvas.style=canvas.style||{}}catch(e){}return canvas},isBrowser:function(){return typeof exports!=="object"},_isInDocument:function(el){while(el=el.parentNode){if(el==Konva.document){return true}}return false},_simplifyArray:function(arr){var retArr=[],len=arr.length,util=Konva.Util,n,val;for(n=0;n<len;n++){val=arr[n];if(util._isNumber(val)){val=Math.round(val*1e3)/1e3}else if(!util._isString(val)){val=val.toString()}retArr.push(val)}return retArr},_getImage:function(arg,callback){var imageObj,canvas;if(!arg){callback(null)}else if(this._isElement(arg)){callback(arg)}else if(this._isString(arg)){imageObj=new Konva.window.Image;imageObj.onload=function(){callback(imageObj)};imageObj.src=arg}else if(arg.data){canvas=Konva.Util.createCanvasElement();canvas.width=arg.width;canvas.height=arg.height;var _context=canvas.getContext(CONTEXT_2D);_context.putImageData(arg,0,0);this._getImage(canvas.toDataURL(),callback)}else{callback(null)}},_getRGBAString:function(obj){var red=obj.red||0,green=obj.green||0,blue=obj.blue||0,alpha=obj.alpha||1;return["rgba(",red,",",green,",",blue,",",alpha,")"].join(EMPTY_STRING)},_rgbToHex:function(r,g,b){return((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1)},_hexToRgb:function(hex){hex=hex.replace(HASH,EMPTY_STRING);var bigint=parseInt(hex,16);return{r:bigint>>16&255,g:bigint>>8&255,b:bigint&255}},getRandomColor:function(){var randColor=(Math.random()*16777215<<0).toString(16);while(randColor.length<6){randColor=ZERO+randColor}return HASH+randColor},get:function(val,def){if(val===undefined){return def}else{return val}},getRGB:function(color){var rgb;if(color in COLORS){rgb=COLORS[color];return{r:rgb[0],g:rgb[1],b:rgb[2]}}else if(color[0]===HASH){return this._hexToRgb(color.substring(1))}else if(color.substr(0,4)===RGB_PAREN){rgb=RGB_REGEX.exec(color.replace(/ /g,""));return{r:parseInt(rgb[1],10),g:parseInt(rgb[2],10),b:parseInt(rgb[3],10)}}else{return{r:0,g:0,b:0}}},colorToRGBA:function(str){str=str||"black";return Konva.Util._namedColorToRBA(str)||Konva.Util._hex3ColorToRGBA(str)||Konva.Util._hex6ColorToRGBA(str)||Konva.Util._rgbColorToRGBA(str)||Konva.Util._rgbaColorToRGBA(str)},_namedColorToRBA:function(str){var c=COLORS[str.toLowerCase()];if(!c){return null}return{r:c[0],g:c[1],b:c[2],a:1}},_rgbColorToRGBA:function(str){if(str.indexOf("rgb(")===0){str=str.match(/rgb\(([^)]+)\)/)[1];var parts=str.split(/ *, */).map(Number);return{r:parts[0],g:parts[1],b:parts[2],a:1}}},_rgbaColorToRGBA:function(str){if(str.indexOf("rgba(")===0){str=str.match(/rgba\(([^)]+)\)/)[1];var parts=str.split(/ *, */).map(Number);return{r:parts[0],g:parts[1],b:parts[2],a:parts[3]}}},_hex6ColorToRGBA:function(str){if(str[0]==="#"&&str.length===7){return{r:parseInt(str.slice(1,3),16),g:parseInt(str.slice(3,5),16),b:parseInt(str.slice(5,7),16),a:1}}},_hex3ColorToRGBA:function(str){if(str[0]==="#"&&str.length===4){return{r:parseInt(str[1]+str[1],16),g:parseInt(str[2]+str[2],16),b:parseInt(str[3]+str[3],16),a:1}}},_merge:function(o1,o2){var retObj=this._clone(o2);for(var key in o1){if(this._isObject(o1[key])){retObj[key]=this._merge(o1[key],retObj[key])}else{retObj[key]=o1[key]}}return retObj},cloneObject:function(obj){var retObj={};for(var key in obj){if(this._isObject(obj[key])){retObj[key]=this.cloneObject(obj[key])}else if(this._isArray(obj[key])){retObj[key]=this.cloneArray(obj[key])}else{retObj[key]=obj[key]}}return retObj},cloneArray:function(arr){return arr.slice(0)},_degToRad:function(deg){return deg*PI_OVER_DEG180},_radToDeg:function(rad){return rad*DEG180_OVER_PI},_capitalize:function(str){return str.charAt(0).toUpperCase()+str.slice(1)},throw:function(str){throw new Error(KONVA_ERROR+str)},error:function(str){console.error(KONVA_ERROR+str)},warn:function(str){if(Konva.global.console&&console.warn&&Konva.showWarnings){console.warn(KONVA_WARNING+str)}},extend:function(child,parent){function Ctor(){this.constructor=child}Ctor.prototype=parent.prototype;var oldProto=child.prototype;child.prototype=new Ctor;for(var key in oldProto){if(oldProto.hasOwnProperty(key)){child.prototype[key]=oldProto[key]}}child.__super__=parent.prototype;child.super=parent},addMethods:function(constructor,methods){var key;for(key in methods){constructor.prototype[key]=methods[key]}},_getControlPoints:function(x0,y0,x1,y1,x2,y2,t){var d01=Math.sqrt(Math.pow(x1-x0,2)+Math.pow(y1-y0,2)),d12=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2)),fa=t*d01/(d01+d12),fb=t*d12/(d01+d12),p1x=x1-fa*(x2-x0),p1y=y1-fa*(y2-y0),p2x=x1+fb*(x2-x0),p2y=y1+fb*(y2-y0);return[p1x,p1y,p2x,p2y]},_expandPoints:function(p,tension){var len=p.length,allPoints=[],n,cp;for(n=2;n<len-2;n+=2){cp=Konva.Util._getControlPoints(p[n-2],p[n-1],p[n],p[n+1],p[n+2],p[n+3],tension);allPoints.push(cp[0]);allPoints.push(cp[1]);allPoints.push(p[n]);allPoints.push(p[n+1]);allPoints.push(cp[2]);allPoints.push(cp[3])}return allPoints},_removeLastLetter:function(str){return str.substring(0,str.length-1)},each:function(obj,func){for(var key in obj){func(key,obj[key])}},_getProjectionToSegment:function(x1,y1,x2,y2,x3,y3){var x,y,dist;var pd2=(x1-x2)*(x1-x2)+(y1-y2)*(y1-y2);if(pd2==0){x=x1;y=y1;dist=(x3-x2)*(x3-x2)+(y3-y2)*(y3-y2)}else{var u=((x3-x1)*(x2-x1)+(y3-y1)*(y2-y1))/pd2;if(u<0){x=x1;y=y1;dist=(x1-x3)*(x1-x3)+(y1-y3)*(y1-y3)}else if(u>1){x=x2;y=y2;dist=(x2-x3)*(x2-x3)+(y2-y3)*(y2-y3)}else{x=x1+u*(x2-x1);y=y1+u*(y2-y1);dist=(x-x3)*(x-x3)+(y-y3)*(y-y3)}}return[x,y,dist]},_getProjectionToLine:function(pt,line,isClosed){var pc=Konva.Util.cloneObject(pt);var dist=Number.MAX_VALUE;line.forEach(function(p1,i){if(!isClosed&&i===line.length-1){return}var p2=line[(i+1)%line.length];var proj=Konva.Util._getProjectionToSegment(p1.x,p1.y,p2.x,p2.y,pt.x,pt.y);var px=proj[0],py=proj[1],pdist=proj[2];if(pdist<dist){pc.x=px;pc.y=py;dist=pdist}});return pc},_prepareArrayForTween:function(startArray,endArray,isClosed){var n,start=[],end=[];if(startArray.length>endArray.length){var temp=endArray;endArray=startArray;startArray=temp}for(n=0;n<startArray.length;n+=2){start.push({x:startArray[n],y:startArray[n+1]})}for(n=0;n<endArray.length;n+=2){end.push({x:endArray[n],y:endArray[n+1]})}var newStart=[];end.forEach(function(point){var pr=Konva.Util._getProjectionToLine(point,start,isClosed);newStart.push(pr.x);newStart.push(pr.y)});return newStart}}})();(function(){"use strict";var canvas=Konva.Util.createCanvasElement(),context=canvas.getContext("2d"),_pixelRatio=function(){var devicePixelRatio=Konva.window.devicePixelRatio||1,backingStoreRatio=context.webkitBackingStorePixelRatio||context.mozBackingStorePixelRatio||context.msBackingStorePixelRatio||context.oBackingStorePixelRatio||context.backingStorePixelRatio||1;return devicePixelRatio/backingStoreRatio}();Konva.Canvas=function(config){this.init(config)};Konva.Canvas.prototype={init:function(config){var conf=config||{};var pixelRatio=conf.pixelRatio||Konva.pixelRatio||_pixelRatio;this.pixelRatio=pixelRatio;this._canvas=Konva.Util.createCanvasElement();this._canvas.style.padding=0;this._canvas.style.margin=0;this._canvas.style.border=0;this._canvas.style.background="transparent";this._canvas.style.position="absolute";this._canvas.style.top=0;this._canvas.style.left=0},getContext:function(){return this.context},getPixelRatio:function(){return this.pixelRatio},setPixelRatio:function(pixelRatio){var previousRatio=this.pixelRatio;this.pixelRatio=pixelRatio;this.setSize(this.getWidth()/previousRatio,this.getHeight()/previousRatio)},setWidth:function(width){this.width=this._canvas.width=width*this.pixelRatio;this._canvas.style.width=width+"px";var pixelRatio=this.pixelRatio,_context=this.getContext()._context;_context.scale(pixelRatio,pixelRatio)},setHeight:function(height){this.height=this._canvas.height=height*this.pixelRatio;this._canvas.style.height=height+"px";var pixelRatio=this.pixelRatio,_context=this.getContext()._context;_context.scale(pixelRatio,pixelRatio)},getWidth:function(){return this.width},getHeight:function(){return this.height},setSize:function(width,height){this.setWidth(width);this.setHeight(height)},toDataURL:function(mimeType,quality){try{return this._canvas.toDataURL(mimeType,quality)}catch(e){try{return this._canvas.toDataURL()}catch(err){Konva.Util.warn("Unable to get data URL. "+err.message);return""}}}};Konva.SceneCanvas=function(config){var conf=config||{};var width=conf.width||0,height=conf.height||0;Konva.Canvas.call(this,conf);this.context=new Konva.SceneContext(this);this.setSize(width,height)};Konva.Util.extend(Konva.SceneCanvas,Konva.Canvas);Konva.HitCanvas=function(config){var conf=config||{};var width=conf.width||0,height=conf.height||0;Konva.Canvas.call(this,conf);this.context=new Konva.HitContext(this);this.setSize(width,height);this.hitCanvas=true};Konva.Util.extend(Konva.HitCanvas,Konva.Canvas)})();(function(){"use strict";var COMMA=",",OPEN_PAREN="(",CLOSE_PAREN=")",OPEN_PAREN_BRACKET="([",CLOSE_BRACKET_PAREN="])",SEMICOLON=";",DOUBLE_PAREN="()",EQUALS="=",CONTEXT_METHODS=["arc","arcTo","beginPath","bezierCurveTo","clearRect","clip","closePath","createLinearGradient","createPattern","createRadialGradient","drawImage","fill","fillText","getImageData","createImageData","lineTo","moveTo","putImageData","quadraticCurveTo","rect","restore","rotate","save","scale","setLineDash","setTransform","stroke","strokeText","transform","translate"];var CONTEXT_PROPERTIES=["fillStyle","strokeStyle","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","lineCap","lineJoin","lineWidth","miterLimit","font","textAlign","textBaseline","globalAlpha","globalCompositeOperation"];Konva.Context=function(canvas){this.init(canvas)};Konva.Context.prototype={init:function(canvas){this.canvas=canvas;this._context=canvas._canvas.getContext("2d");if(Konva.enableTrace){this.traceArr=[];this._enableTrace()}},fillShape:function(shape){if(shape.getFillEnabled()){this._fill(shape)}},strokeShape:function(shape){if(shape.getStrokeEnabled()){this._stroke(shape)}},fillStrokeShape:function(shape){var fillEnabled=shape.getFillEnabled();if(fillEnabled){this._fill(shape)}if(shape.getStrokeEnabled()){this._stroke(shape)}},getTrace:function(relaxed){var traceArr=this.traceArr,len=traceArr.length,str="",n,trace,method,args;for(n=0;n<len;n++){trace=traceArr[n];method=trace.method;if(method){args=trace.args;str+=method;if(relaxed){str+=DOUBLE_PAREN}else{if(Konva.Util._isArray(args[0])){str+=OPEN_PAREN_BRACKET+args.join(COMMA)+CLOSE_BRACKET_PAREN}else{str+=OPEN_PAREN+args.join(COMMA)+CLOSE_PAREN}}}else{str+=trace.property;if(!relaxed){str+=EQUALS+trace.val}}str+=SEMICOLON}return str},clearTrace:function(){this.traceArr=[]},_trace:function(str){var traceArr=this.traceArr,len;traceArr.push(str);len=traceArr.length;if(len>=Konva.traceArrMax){traceArr.shift()}},reset:function(){var pixelRatio=this.getCanvas().getPixelRatio();this.setTransform(1*pixelRatio,0,0,1*pixelRatio,0,0)},getCanvas:function(){return this.canvas},clear:function(bounds){var canvas=this.getCanvas();if(bounds){this.clearRect(bounds.x||0,bounds.y||0,bounds.width||0,bounds.height||0)}else{this.clearRect(0,0,canvas.getWidth()/canvas.pixelRatio,canvas.getHeight()/canvas.pixelRatio)}},_applyLineCap:function(shape){var lineCap=shape.getLineCap();if(lineCap){this.setAttr("lineCap",lineCap)}},_applyOpacity:function(shape){var absOpacity=shape.getAbsoluteOpacity();if(absOpacity!==1){this.setAttr("globalAlpha",absOpacity)}},_applyLineJoin:function(shape){var lineJoin=shape.getLineJoin();if(lineJoin){this.setAttr("lineJoin",lineJoin)}},setAttr:function(attr,val){this._context[attr]=val},arc:function(){var a=arguments;this._context.arc(a[0],a[1],a[2],a[3],a[4],a[5])},beginPath:function(){this._context.beginPath()},bezierCurveTo:function(){var a=arguments;this._context.bezierCurveTo(a[0],a[1],a[2],a[3],a[4],a[5])},clearRect:function(){var a=arguments;this._context.clearRect(a[0],a[1],a[2],a[3])},clip:function(){this._context.clip()},closePath:function(){this._context.closePath()},createImageData:function(){var a=arguments;if(a.length===2){return this._context.createImageData(a[0],a[1])}else if(a.length===1){return this._context.createImageData(a[0])}},createLinearGradient:function(){var a=arguments;return this._context.createLinearGradient(a[0],a[1],a[2],a[3])},createPattern:function(){var a=arguments;return this._context.createPattern(a[0],a[1])},createRadialGradient:function(){var a=arguments;return this._context.createRadialGradient(a[0],a[1],a[2],a[3],a[4],a[5])},drawImage:function(){var a=arguments,_context=this._context;if(a.length===3){_context.drawImage(a[0],a[1],a[2])}else if(a.length===5){try{_context.drawImage(a[0],a[1],a[2],a[3],a[4])}catch(e){Konva.Util.warn("Unable to drawImage due to: "+e.message)}}else if(a.length===9){_context.drawImage(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])}},isPointInPath:function(x,y){return this._context.isPointInPath(x,y)},fill:function(){this._context.fill()},fillRect:function(x,y,width,height){this._context.fillRect(x,y,width,height)},strokeRect:function(x,y,width,height){this._context.strokeRect(x,y,width,height)},fillText:function(){var a=arguments;this._context.fillText(a[0],a[1],a[2])},measureText:function(text){return this._context.measureText(text)},getImageData:function(){var a=arguments;return this._context.getImageData(a[0],a[1],a[2],a[3])},lineTo:function(){var a=arguments;this._context.lineTo(a[0],a[1])},moveTo:function(){var a=arguments;this._context.moveTo(a[0],a[1])},rect:function(){var a=arguments;this._context.rect(a[0],a[1],a[2],a[3])},putImageData:function(){var a=arguments;this._context.putImageData(a[0],a[1],a[2])},quadraticCurveTo:function(){var a=arguments;this._context.quadraticCurveTo(a[0],a[1],a[2],a[3])},restore:function(){this._context.restore()},rotate:function(){var a=arguments;this._context.rotate(a[0])},save:function(){this._context.save()},scale:function(){var a=arguments;this._context.scale(a[0],a[1])},setLineDash:function(){var a=arguments,_context=this._context;if(this._context.setLineDash){_context.setLineDash(a[0])}else if("mozDash"in _context){_context.mozDash=a[0]}else if("webkitLineDash"in _context){_context.webkitLineDash=a[0]}},getLineDash:function(){return this._context.getLineDash()},setTransform:function(){var a=arguments;this._context.setTransform(a[0],a[1],a[2],a[3],a[4],a[5])},stroke:function(){this._context.stroke()},strokeText:function(){var a=arguments;this._context.strokeText(a[0],a[1],a[2])},transform:function(){var a=arguments;this._context.transform(a[0],a[1],a[2],a[3],a[4],a[5])},translate:function(){var a=arguments;this._context.translate(a[0],a[1])},_enableTrace:function(){var that=this,len=CONTEXT_METHODS.length,_simplifyArray=Konva.Util._simplifyArray,origSetter=this.setAttr,n,args;var func=function(methodName){var origMethod=that[methodName],ret;that[methodName]=function(){args=_simplifyArray(Array.prototype.slice.call(arguments,0));ret=origMethod.apply(that,arguments);that._trace({method:methodName,args:args});return ret}};for(n=0;n<len;n++){func(CONTEXT_METHODS[n])}that.setAttr=function(){origSetter.apply(that,arguments);that._trace({property:arguments[0],val:arguments[1]})}}};CONTEXT_PROPERTIES.forEach(function(prop){Object.defineProperty(Konva.Context.prototype,prop,{get:function(){return this._context[prop]},set:function(val){this._context[prop]=val}})});Konva.SceneContext=function(canvas){Konva.Context.call(this,canvas)};Konva.SceneContext.prototype={_fillColor:function(shape){var fill=shape.fill();this.setAttr("fillStyle",fill);shape._fillFunc(this)},_fillPattern:function(shape){var fillPatternX=shape.getFillPatternX(),fillPatternY=shape.getFillPatternY(),fillPatternScale=shape.getFillPatternScale(),fillPatternRotation=Konva.getAngle(shape.getFillPatternRotation()),fillPatternOffset=shape.getFillPatternOffset();if(fillPatternX||fillPatternY){this.translate(fillPatternX||0,fillPatternY||0)}if(fillPatternRotation){this.rotate(fillPatternRotation)}if(fillPatternScale){this.scale(fillPatternScale.x,fillPatternScale.y)}if(fillPatternOffset){this.translate(-1*fillPatternOffset.x,-1*fillPatternOffset.y)}this.setAttr("fillStyle",this.createPattern(shape.getFillPatternImage(),shape.getFillPatternRepeat()||"repeat"));this.fill()},_fillLinearGradient:function(shape){var start=shape.getFillLinearGradientStartPoint(),end=shape.getFillLinearGradientEndPoint(),colorStops=shape.getFillLinearGradientColorStops(),grd=this.createLinearGradient(start.x,start.y,end.x,end.y);if(colorStops){for(var n=0;n<colorStops.length;n+=2){grd.addColorStop(colorStops[n],colorStops[n+1])}this.setAttr("fillStyle",grd);shape._fillFunc(this)}},_fillRadialGradient:function(shape){var start=shape.getFillRadialGradientStartPoint(),end=shape.getFillRadialGradientEndPoint(),startRadius=shape.getFillRadialGradientStartRadius(),endRadius=shape.getFillRadialGradientEndRadius(),colorStops=shape.getFillRadialGradientColorStops(),grd=this.createRadialGradient(start.x,start.y,startRadius,end.x,end.y,endRadius);for(var n=0;n<colorStops.length;n+=2){grd.addColorStop(colorStops[n],colorStops[n+1])}this.setAttr("fillStyle",grd);this.fill()},_fill:function(shape){var hasColor=shape.fill(),hasPattern=shape.getFillPatternImage(),hasLinearGradient=shape.getFillLinearGradientColorStops(),hasRadialGradient=shape.getFillRadialGradientColorStops(),fillPriority=shape.getFillPriority();if(hasColor&&fillPriority==="color"){this._fillColor(shape)}else if(hasPattern&&fillPriority==="pattern"){this._fillPattern(shape)}else if(hasLinearGradient&&fillPriority==="linear-gradient"){this._fillLinearGradient(shape)}else if(hasRadialGradient&&fillPriority==="radial-gradient"){this._fillRadialGradient(shape)}else if(hasColor){this._fillColor(shape)}else if(hasPattern){this._fillPattern(shape)}else if(hasLinearGradient){this._fillLinearGradient(shape)}else if(hasRadialGradient){this._fillRadialGradient(shape)}},_stroke:function(shape){var dash=shape.dash(),strokeScaleEnabled=shape.getStrokeScaleEnabled()||shape instanceof Konva.Text;if(shape.hasStroke()){if(!strokeScaleEnabled){this.save();this.setTransform(1,0,0,1,0,0)}this._applyLineCap(shape);if(dash&&shape.dashEnabled()){this.setLineDash(dash)}this.setAttr("lineWidth",shape.strokeWidth());this.setAttr("strokeStyle",shape.stroke());if(!shape.getShadowForStrokeEnabled()){this.setAttr("shadowColor","rgba(0,0,0,0)")}shape._strokeFunc(this);if(!strokeScaleEnabled){this.restore()}}},_applyShadow:function(shape){var util=Konva.Util,color=util.get(shape.getShadowRGBA(),"black"),blur=util.get(shape.getShadowBlur(),5),offset=util.get(shape.getShadowOffset(),{x:0,y:0}),scale=shape.getAbsoluteScale(),scaleX=scale.x,scaleY=scale.y;this.setAttr("shadowColor",color);this.setAttr("shadowBlur",blur);this.setAttr("shadowOffsetX",offset.x*scaleX);this.setAttr("shadowOffsetY",offset.y*scaleY)}};Konva.Util.extend(Konva.SceneContext,Konva.Context);Konva.HitContext=function(canvas){Konva.Context.call(this,canvas)};Konva.HitContext.prototype={_fill:function(shape){this.save();this.setAttr("fillStyle",shape.colorKey);shape._fillFuncHit(this);this.restore()},_stroke:function(shape){if(shape.hasStroke()&&shape.strokeHitEnabled()){var strokeScaleEnabled=shape.getStrokeScaleEnabled()||shape instanceof Konva.Text;if(!strokeScaleEnabled){this.save();this.setTransform(1,0,0,1,0,0)}this._applyLineCap(shape);this.setAttr("lineWidth",shape.strokeWidth());this.setAttr("strokeStyle",shape.colorKey);shape._strokeFuncHit(this);if(!strokeScaleEnabled){this.restore()}}}};Konva.Util.extend(Konva.HitContext,Konva.Context)})();(function(){"use strict";var GET="get",SET="set";Konva.Factory={addGetterSetter:function(constructor,attr,def,validator,after){this.addGetter(constructor,attr,def);this.addSetter(constructor,attr,validator,after);this.addOverloadedGetterSetter(constructor,attr)},addGetter:function(constructor,attr,def){var method=GET+Konva.Util._capitalize(attr);constructor.prototype[method]=function(){var val=this.attrs[attr];return val===undefined?def:val}},addSetter:function(constructor,attr,validator,after){var method=SET+Konva.Util._capitalize(attr);constructor.prototype[method]=function(val){if(validator){val=validator.call(this,val)}this._setAttr(attr,val);if(after){after.call(this)}return this}},addComponentsGetterSetter:function(constructor,attr,components,validator,after){var len=components.length,capitalize=Konva.Util._capitalize,getter=GET+capitalize(attr),setter=SET+capitalize(attr),n,component;constructor.prototype[getter]=function(){var ret={};for(n=0;n<len;n++){component=components[n];ret[component]=this.getAttr(attr+capitalize(component))}return ret};constructor.prototype[setter]=function(val){var oldVal=this.attrs[attr],key;if(validator){val=validator.call(this,val)}for(key in val){if(!val.hasOwnProperty(key)){continue}this._setAttr(attr+capitalize(key),val[key])}this._fireChangeEvent(attr,oldVal,val);if(after){after.call(this)}return this};this.addOverloadedGetterSetter(constructor,attr)},addOverloadedGetterSetter:function(constructor,attr){
var capitalizedAttr=Konva.Util._capitalize(attr),setter=SET+capitalizedAttr,getter=GET+capitalizedAttr;constructor.prototype[attr]=function(){if(arguments.length){this[setter](arguments[0]);return this}return this[getter]()}},addDeprecatedGetterSetter:function(constructor,attr,def,validator){var method=GET+Konva.Util._capitalize(attr);var message=attr+" property is deprecated and will be removed soon. Look at Konva change log for more information.";constructor.prototype[method]=function(){Konva.Util.error(message);var val=this.attrs[attr];return val===undefined?def:val};this.addSetter(constructor,attr,validator,function(){Konva.Util.error(message)});this.addOverloadedGetterSetter(constructor,attr)},backCompat:function(constructor,methods){Konva.Util.each(methods,function(oldMethodName,newMethodName){var method=constructor.prototype[newMethodName];constructor.prototype[oldMethodName]=function(){method.apply(this,arguments);Konva.Util.error(oldMethodName+" method is deprecated and will be removed soon. Use "+newMethodName+" instead")}})},afterSetFilter:function(){this._filterUpToDate=false}};Konva.Validators={RGBComponent:function(val){if(val>255){return 255}else if(val<0){return 0}return Math.round(val)},alphaComponent:function(val){if(val>1){return 1}else if(val<1e-4){return 1e-4}return val}}})();(function(Konva){"use strict";var ABSOLUTE_OPACITY="absoluteOpacity",ABSOLUTE_TRANSFORM="absoluteTransform",ABSOLUTE_SCALE="absoluteScale",CHANGE="Change",CHILDREN="children",DOT=".",EMPTY_STRING="",GET="get",ID="id",KONVA="konva",LISTENING="listening",MOUSEENTER="mouseenter",MOUSELEAVE="mouseleave",NAME="name",SET="set",SHAPE="Shape",SPACE=" ",STAGE="stage",TRANSFORM="transform",UPPER_STAGE="Stage",VISIBLE="visible",CLONE_BLACK_LIST=["id"],TRANSFORM_CHANGE_STR=["xChange.konva","yChange.konva","scaleXChange.konva","scaleYChange.konva","skewXChange.konva","skewYChange.konva","rotationChange.konva","offsetXChange.konva","offsetYChange.konva","transformsEnabledChange.konva"].join(SPACE),SCALE_CHANGE_STR=["scaleXChange.konva","scaleYChange.konva"].join(SPACE);Konva.Node=function(config){this._init(config)};Konva.Util.addMethods(Konva.Node,{_init:function(config){var that=this;this._id=Konva.idCounter++;this.eventListeners={};this.attrs={};this._cache={};this._filterUpToDate=false;this.setAttrs(config);this.on(TRANSFORM_CHANGE_STR,function(){this._clearCache(TRANSFORM);that._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM)});this.on(SCALE_CHANGE_STR,function(){that._clearSelfAndDescendantCache(ABSOLUTE_SCALE)});this.on("visibleChange.konva",function(){that._clearSelfAndDescendantCache(VISIBLE)});this.on("listeningChange.konva",function(){that._clearSelfAndDescendantCache(LISTENING)});this.on("opacityChange.konva",function(){that._clearSelfAndDescendantCache(ABSOLUTE_OPACITY)})},_clearCache:function(attr){if(attr){delete this._cache[attr]}else{this._cache={}}},_getCache:function(attr,privateGetter){var cache=this._cache[attr];if(cache===undefined){this._cache[attr]=privateGetter.call(this)}return this._cache[attr]},_clearSelfAndDescendantCache:function(attr){this._clearCache(attr);if(this.children){this.getChildren().each(function(node){node._clearSelfAndDescendantCache(attr)})}},clearCache:function(){delete this._cache.canvas;this._filterUpToDate=false;return this},cache:function(config){var conf=config||{},rect=this.getClientRect(true),width=conf.width||rect.width,height=conf.height||rect.height,x=conf.x||rect.x,y=conf.y||rect.y,offset=conf.offset||0,drawBorder=conf.drawBorder||false;if(!width||!height){throw new Error("Width or height of caching configuration equals 0.")}width+=offset*2;height+=offset*2;x-=offset;y-=offset;var cachedSceneCanvas=new Konva.SceneCanvas({width:width,height:height}),cachedFilterCanvas=new Konva.SceneCanvas({width:width,height:height}),cachedHitCanvas=new Konva.HitCanvas({pixelRatio:1,width:width,height:height}),sceneContext=cachedSceneCanvas.getContext(),hitContext=cachedHitCanvas.getContext();cachedHitCanvas.isCache=true;this.clearCache();sceneContext.save();hitContext.save();sceneContext.translate(-x,-y);hitContext.translate(-x,-y);this.drawScene(cachedSceneCanvas,this,true);this.drawHit(cachedHitCanvas,this,true);sceneContext.restore();hitContext.restore();if(drawBorder){sceneContext.save();sceneContext.beginPath();sceneContext.rect(0,0,width,height);sceneContext.closePath();sceneContext.setAttr("strokeStyle","red");sceneContext.setAttr("lineWidth",5);sceneContext.stroke();sceneContext.restore()}this._cache.canvas={scene:cachedSceneCanvas,filter:cachedFilterCanvas,hit:cachedHitCanvas,x:x,y:y};return this},getClientRect:function(){throw new Error('abstract "getClientRect" method call')},_transformedRect:function(rect){var points=[{x:rect.x,y:rect.y},{x:rect.x+rect.width,y:rect.y},{x:rect.x+rect.width,y:rect.y+rect.height},{x:rect.x,y:rect.y+rect.height}];var minX,minY,maxX,maxY;var trans=this.getTransform();points.forEach(function(point){var transformed=trans.point(point);if(minX===undefined){minX=maxX=transformed.x;minY=maxY=transformed.y}minX=Math.min(minX,transformed.x);minY=Math.min(minY,transformed.y);maxX=Math.max(maxX,transformed.x);maxY=Math.max(maxY,transformed.y)});return{x:minX,y:minY,width:maxX-minX,height:maxY-minY}},_drawCachedSceneCanvas:function(context){context.save();context._applyOpacity(this);context.translate(this._cache.canvas.x,this._cache.canvas.y);var cacheCanvas=this._getCachedSceneCanvas();var ratio=cacheCanvas.pixelRatio;context.drawImage(cacheCanvas._canvas,0,0,cacheCanvas.width/ratio,cacheCanvas.height/ratio);context.restore()},_drawCachedHitCanvas:function(context){var cachedCanvas=this._cache.canvas,hitCanvas=cachedCanvas.hit;context.save();context.translate(this._cache.canvas.x,this._cache.canvas.y);context.drawImage(hitCanvas._canvas,0,0);context.restore()},_getCachedSceneCanvas:function(){var filters=this.filters(),cachedCanvas=this._cache.canvas,sceneCanvas=cachedCanvas.scene,filterCanvas=cachedCanvas.filter,filterContext=filterCanvas.getContext(),len,imageData,n,filter;if(filters){if(!this._filterUpToDate){var ratio=sceneCanvas.pixelRatio;try{len=filters.length;filterContext.clear();filterContext.drawImage(sceneCanvas._canvas,0,0,sceneCanvas.getWidth()/ratio,sceneCanvas.getHeight()/ratio);imageData=filterContext.getImageData(0,0,filterCanvas.getWidth(),filterCanvas.getHeight());for(n=0;n<len;n++){filter=filters[n];filter.call(this,imageData);filterContext.putImageData(imageData,0,0)}}catch(e){Konva.Util.warn("Unable to apply filter. "+e.message)}this._filterUpToDate=true}return filterCanvas}return sceneCanvas},on:function(evtStr,handler){if(arguments.length===3){return this._delegate.apply(this,arguments)}var events=evtStr.split(SPACE),len=events.length,n,event,parts,baseEvent,name;for(n=0;n<len;n++){event=events[n];parts=event.split(DOT);baseEvent=parts[0];name=parts[1]||EMPTY_STRING;if(!this.eventListeners[baseEvent]){this.eventListeners[baseEvent]=[]}this.eventListeners[baseEvent].push({name:name,handler:handler})}return this},off:function(evtStr){var events=(evtStr||"").split(SPACE),len=events.length,n,t,event,parts,baseEvent,name;if(!evtStr){for(t in this.eventListeners){this._off(t)}}for(n=0;n<len;n++){event=events[n];parts=event.split(DOT);baseEvent=parts[0];name=parts[1];if(baseEvent){if(this.eventListeners[baseEvent]){this._off(baseEvent,name)}}else{for(t in this.eventListeners){this._off(t,name)}}}return this},dispatchEvent:function(evt){var e={target:this,type:evt.type,evt:evt};this.fire(evt.type,e);return this},addEventListener:function(type,handler){this.on(type,function(evt){handler.call(this,evt.evt)});return this},removeEventListener:function(type){this.off(type);return this},_delegate:function(event,selector,handler){var stopNode=this;this.on(event,function(evt){var targets=evt.target.findAncestors(selector,true,stopNode);for(var i=0;i<targets.length;i++){evt=Konva.Util.cloneObject(evt);evt.currentTarget=targets[i];handler.call(targets[i],evt)}})},remove:function(){var parent=this.getParent();if(parent&&parent.children){parent.children.splice(this.index,1);parent._setChildrenIndices();delete this.parent}this._clearSelfAndDescendantCache(STAGE);this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);this._clearSelfAndDescendantCache(VISIBLE);this._clearSelfAndDescendantCache(LISTENING);this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);return this},destroy:function(){Konva._removeId(this.getId());Konva._removeName(this.getName(),this._id);this.remove();return this},getAttr:function(attr){var method=GET+Konva.Util._capitalize(attr);if(Konva.Util._isFunction(this[method])){return this[method]()}return this.attrs[attr]},getAncestors:function(){var parent=this.getParent(),ancestors=new Konva.Collection;while(parent){ancestors.push(parent);parent=parent.getParent()}return ancestors},getAttrs:function(){return this.attrs||{}},setAttrs:function(config){var key,method;if(!config){return this}for(key in config){if(key===CHILDREN){continue}method=SET+Konva.Util._capitalize(key);if(Konva.Util._isFunction(this[method])){this[method](config[key])}else{this._setAttr(key,config[key])}}return this},isListening:function(){return this._getCache(LISTENING,this._isListening)},_isListening:function(){var listening=this.getListening(),parent=this.getParent();if(listening==="inherit"){if(parent){return parent.isListening()}else{return true}}else{return listening}},isVisible:function(){return this._getCache(VISIBLE,this._isVisible)},_isVisible:function(){var visible=this.getVisible(),parent=this.getParent();if(visible==="inherit"){if(parent){return parent.isVisible()}else{return true}}else{return visible}},shouldDrawHit:function(canvas){var layer=this.getLayer();return canvas&&canvas.isCache||layer&&layer.hitGraphEnabled()&&this.isListening()&&this.isVisible()},show:function(){this.setVisible(true);return this},hide:function(){this.setVisible(false);return this},getZIndex:function(){return this.index||0},getAbsoluteZIndex:function(){var depth=this.getDepth(),that=this,index=0,nodes,len,n,child;function addChildren(children){nodes=[];len=children.length;for(n=0;n<len;n++){child=children[n];index++;if(child.nodeType!==SHAPE){nodes=nodes.concat(child.getChildren().toArray())}if(child._id===that._id){n=len}}if(nodes.length>0&&nodes[0].getDepth()<=depth){addChildren(nodes)}}if(that.nodeType!==UPPER_STAGE){addChildren(that.getStage().getChildren())}return index},getDepth:function(){var depth=0,parent=this.parent;while(parent){depth++;parent=parent.parent}return depth},setPosition:function(pos){this.setX(pos.x);this.setY(pos.y);return this},getPosition:function(){return{x:this.getX(),y:this.getY()}},getAbsolutePosition:function(top){var absoluteMatrix=this.getAbsoluteTransform(top).getMatrix(),absoluteTransform=new Konva.Transform,offset=this.offset();absoluteTransform.m=absoluteMatrix.slice();absoluteTransform.translate(offset.x,offset.y);return absoluteTransform.getTranslation()},setAbsolutePosition:function(pos){var origTrans=this._clearTransform(),it;this.attrs.x=origTrans.x;this.attrs.y=origTrans.y;delete origTrans.x;delete origTrans.y;it=this.getAbsoluteTransform();it.invert();it.translate(pos.x,pos.y);pos={x:this.attrs.x+it.getTranslation().x,y:this.attrs.y+it.getTranslation().y};this.setPosition({x:pos.x,y:pos.y});this._setTransform(origTrans);return this},_setTransform:function(trans){var key;for(key in trans){this.attrs[key]=trans[key]}this._clearCache(TRANSFORM);this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM)},_clearTransform:function(){var trans={x:this.getX(),y:this.getY(),rotation:this.getRotation(),scaleX:this.getScaleX(),scaleY:this.getScaleY(),offsetX:this.getOffsetX(),offsetY:this.getOffsetY(),skewX:this.getSkewX(),skewY:this.getSkewY()};this.attrs.x=0;this.attrs.y=0;this.attrs.rotation=0;this.attrs.scaleX=1;this.attrs.scaleY=1;this.attrs.offsetX=0;this.attrs.offsetY=0;this.attrs.skewX=0;this.attrs.skewY=0;this._clearCache(TRANSFORM);this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);return trans},move:function(change){var changeX=change.x,changeY=change.y,x=this.getX(),y=this.getY();if(changeX!==undefined){x+=changeX}if(changeY!==undefined){y+=changeY}this.setPosition({x:x,y:y});return this},_eachAncestorReverse:function(func,top){var family=[],parent=this.getParent(),len,n;if(top&&top._id===this._id){func(this);return true}family.unshift(this);while(parent&&(!top||parent._id!==top._id)){family.unshift(parent);parent=parent.parent}len=family.length;for(n=0;n<len;n++){func(family[n])}},rotate:function(theta){this.setRotation(this.getRotation()+theta);return this},moveToTop:function(){if(!this.parent){Konva.Util.warn("Node has no parent. moveToTop function is ignored.");return false}var index=this.index;this.parent.children.splice(index,1);this.parent.children.push(this);this.parent._setChildrenIndices();return true},moveUp:function(){if(!this.parent){Konva.Util.warn("Node has no parent. moveUp function is ignored.");return false}var index=this.index,len=this.parent.getChildren().length;if(index<len-1){this.parent.children.splice(index,1);this.parent.children.splice(index+1,0,this);this.parent._setChildrenIndices();return true}return false},moveDown:function(){if(!this.parent){Konva.Util.warn("Node has no parent. moveDown function is ignored.");return false}var index=this.index;if(index>0){this.parent.children.splice(index,1);this.parent.children.splice(index-1,0,this);this.parent._setChildrenIndices();return true}return false},moveToBottom:function(){if(!this.parent){Konva.Util.warn("Node has no parent. moveToBottom function is ignored.");return false}var index=this.index;if(index>0){this.parent.children.splice(index,1);this.parent.children.unshift(this);this.parent._setChildrenIndices();return true}return false},setZIndex:function(zIndex){if(!this.parent){Konva.Util.warn("Node has no parent. zIndex parameter is ignored.");return false}var index=this.index;this.parent.children.splice(index,1);this.parent.children.splice(zIndex,0,this);this.parent._setChildrenIndices();return this},getAbsoluteOpacity:function(){return this._getCache(ABSOLUTE_OPACITY,this._getAbsoluteOpacity)},_getAbsoluteOpacity:function(){var absOpacity=this.getOpacity();if(this.getParent()){absOpacity*=this.getParent().getAbsoluteOpacity()}return absOpacity},moveTo:function(newContainer){if(this.getParent()!==newContainer){this.remove();newContainer.add(this)}return this},toObject:function(){var obj={},attrs=this.getAttrs(),key,val,getter,defaultValue;obj.attrs={};for(key in attrs){val=attrs[key];if(Konva.Util._isFunction(val)||Konva.Util._isElement(val)||(Konva.Util._isObject(val)||Konva.Util._hasMethods(val))){continue}getter=this[key];delete attrs[key];defaultValue=getter?getter.call(this):null;attrs[key]=val;if(defaultValue!==val){obj.attrs[key]=val}}obj.className=this.getClassName();return obj},toJSON:function(){return JSON.stringify(this.toObject())},getParent:function(){return this.parent},findAncestors:function(selector,includeSelf,stopNode){var res=[];if(includeSelf&&this._isMatch(selector)){res.push(this)}var ancestor=this.parent;while(ancestor){if(ancestor===stopNode){return res}if(ancestor._isMatch(selector)){res.push(ancestor)}ancestor=ancestor.parent}return res},findAncestor:function(selector,includeSelf,stopNode){return this.findAncestors(selector,includeSelf,stopNode)[0]},_isMatch:function(selector){if(!selector){return false}var selectorArr=selector.replace(/ /g,"").split(","),len=selectorArr.length,n,sel;for(n=0;n<len;n++){sel=selectorArr[n];if(!Konva.Util.isValidSelector(sel)){Konva.Util.warn('Selector "'+sel+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".');Konva.Util.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".');Konva.Util.warn("Konva is awesome, right?")}if(sel.charAt(0)==="#"){if(this.id()===sel.slice(1)){return true}}else if(sel.charAt(0)==="."){if(this.hasName(sel.slice(1))){return true}}else if(this._get(sel).length!==0){return true}}return false},getLayer:function(){var parent=this.getParent();return parent?parent.getLayer():null},getStage:function(){return this._getCache(STAGE,this._getStage)},_getStage:function(){var parent=this.getParent();if(parent){return parent.getStage()}else{return undefined}},fire:function(eventType,evt,bubble){evt=evt||{};evt.target=evt.target||this;if(bubble){this._fireAndBubble(eventType,evt)}else{this._fire(eventType,evt)}return this},getAbsoluteTransform:function(top){if(top){return this._getAbsoluteTransform(top)}else{return this._getCache(ABSOLUTE_TRANSFORM,this._getAbsoluteTransform)}},_getAbsoluteTransform:function(top){var at=new Konva.Transform,transformsEnabled,trans;this._eachAncestorReverse(function(node){transformsEnabled=node.transformsEnabled();trans=node.getTransform();if(transformsEnabled==="all"){at.multiply(trans)}else if(transformsEnabled==="position"){at.translate(node.x(),node.y())}},top);return at},getAbsoluteScale:function(top){if(top){return this._getAbsoluteTransform(top)}else{return this._getCache(ABSOLUTE_SCALE,this._getAbsoluteScale)}},_getAbsoluteScale:function(top){var scaleX=1,scaleY=1;this._eachAncestorReverse(function(node){scaleX*=node.scaleX();scaleY*=node.scaleY()},top);return{x:scaleX,y:scaleY}},getTransform:function(){return this._getCache(TRANSFORM,this._getTransform)},_getTransform:function(){var m=new Konva.Transform,x=this.getX(),y=this.getY(),rotation=Konva.getAngle(this.getRotation()),scaleX=this.getScaleX(),scaleY=this.getScaleY(),skewX=this.getSkewX(),skewY=this.getSkewY(),offsetX=this.getOffsetX(),offsetY=this.getOffsetY();if(x!==0||y!==0){m.translate(x,y)}if(rotation!==0){m.rotate(rotation)}if(skewX!==0||skewY!==0){m.skew(skewX,skewY)}if(scaleX!==1||scaleY!==1){m.scale(scaleX,scaleY)}if(offsetX!==0||offsetY!==0){m.translate(-1*offsetX,-1*offsetY)}return m},clone:function(obj){var attrs=Konva.Util.cloneObject(this.attrs),key,allListeners,len,n,listener;for(var i in CLONE_BLACK_LIST){var blockAttr=CLONE_BLACK_LIST[i];delete attrs[blockAttr]}for(key in obj){attrs[key]=obj[key]}var node=new this.constructor(attrs);for(key in this.eventListeners){allListeners=this.eventListeners[key];len=allListeners.length;for(n=0;n<len;n++){listener=allListeners[n];if(listener.name.indexOf(KONVA)<0){if(!node.eventListeners[key]){node.eventListeners[key]=[]}node.eventListeners[key].push(listener)}}}return node},toDataURL:function(config){config=config||{};var mimeType=config.mimeType||null,quality=config.quality||null,stage=this.getStage(),x=config.x||0,y=config.y||0,pixelRatio=config.pixelRatio||1,canvas=new Konva.SceneCanvas({width:config.width||this.getWidth()||(stage?stage.getWidth():0),height:config.height||this.getHeight()||(stage?stage.getHeight():0),pixelRatio:pixelRatio}),context=canvas.getContext();context.save();if(x||y){context.translate(-1*x,-1*y)}this.drawScene(canvas);context.restore();return canvas.toDataURL(mimeType,quality)},toImage:function(config){if(!config||!config.callback){throw"callback required for toImage method config argument"}Konva.Util._getImage(this.toDataURL(config),function(img){config.callback(img)})},setSize:function(size){this.setWidth(size.width);this.setHeight(size.height);return this},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return this.attrs.width||0},getHeight:function(){return this.attrs.height||0},getClassName:function(){return this.className||this.nodeType},getType:function(){return this.nodeType},getDragDistance:function(){if(this.attrs.dragDistance!==undefined){return this.attrs.dragDistance}else if(this.parent){return this.parent.getDragDistance()}else{return Konva.dragDistance}},_get:function(selector){return this.className===selector||this.nodeType===selector?[this]:[]},_off:function(type,name){var evtListeners=this.eventListeners[type],i,evtName;for(i=0;i<evtListeners.length;i++){evtName=evtListeners[i].name;if((evtName!=="konva"||name==="konva")&&(!name||evtName===name)){evtListeners.splice(i,1);if(evtListeners.length===0){delete this.eventListeners[type];break}i--}}},_fireChangeEvent:function(attr,oldVal,newVal){this._fire(attr+CHANGE,{oldVal:oldVal,newVal:newVal})},setId:function(id){var oldId=this.getId();Konva._removeId(oldId);Konva._addId(this,id);this._setAttr(ID,id);return this},setName:function(name){var oldNames=(this.getName()||"").split(/\s/g);var newNames=(name||"").split(/\s/g);var subname,i;for(i=0;i<oldNames.length;i++){subname=oldNames[i];if(newNames.indexOf(subname)===-1&&subname){Konva._removeName(subname,this._id)}}for(i=0;i<newNames.length;i++){subname=newNames[i];if(oldNames.indexOf(subname)===-1&&subname){Konva._addName(this,subname)}}this._setAttr(NAME,name);return this},addName:function(name){if(!this.hasName(name)){var oldName=this.name();var newName=oldName?oldName+" "+name:name;this.setName(newName)}return this},hasName:function(name){var names=(this.name()||"").split(/\s/g);return names.indexOf(name)!==-1},removeName:function(name){var names=(this.name()||"").split(/\s/g);var index=names.indexOf(name);if(index!==-1){names.splice(index,1);this.setName(names.join(" "))}return this},setAttr:function(attr,val){var method=SET+Konva.Util._capitalize(attr),func=this[method];if(Konva.Util._isFunction(func)){func.call(this,val)}else{this._setAttr(attr,val)}return this},_setAttr:function(key,val){var oldVal;if(val!==undefined){oldVal=this.attrs[key];if(oldVal===val){return}this.attrs[key]=val;this._fireChangeEvent(key,oldVal,val)}},_setComponentAttr:function(key,component,val){var oldVal;if(val!==undefined){oldVal=this.attrs[key];if(!oldVal){this.attrs[key]=this.getAttr(key)}this.attrs[key][component]=val;this._fireChangeEvent(key,oldVal,val)}},_fireAndBubble:function(eventType,evt,compareShape){var okayToRun=true;if(evt&&this.nodeType===SHAPE){evt.target=this}if(eventType===MOUSEENTER&&compareShape&&(this._id===compareShape._id||this.isAncestorOf&&this.isAncestorOf(compareShape))){okayToRun=false}else if(eventType===MOUSELEAVE&&compareShape&&(this._id===compareShape._id||this.isAncestorOf&&this.isAncestorOf(compareShape))){okayToRun=false}if(okayToRun){this._fire(eventType,evt);var stopBubble=(eventType===MOUSEENTER||eventType===MOUSELEAVE)&&(compareShape&&compareShape.isAncestorOf&&compareShape.isAncestorOf(this)&&!compareShape.isAncestorOf(this.parent));if((evt&&!evt.cancelBubble||!evt)&&this.parent&&this.parent.isListening()&&!stopBubble){if(compareShape&&compareShape.parent){this._fireAndBubble.call(this.parent,eventType,evt,compareShape.parent)}else{this._fireAndBubble.call(this.parent,eventType,evt)}}}},_fire:function(eventType,evt){var events=this.eventListeners[eventType],i;evt=evt||{};evt.currentTarget=this;evt.type=eventType;if(events){for(i=0;i<events.length;i++){events[i].handler.call(this,evt)}}},draw:function(){this.drawScene();this.drawHit();return this}});Konva.Node.create=function(data,container){if(Konva.Util._isString(data)){data=JSON.parse(data)}return this._createNode(data,container)};Konva.Node._createNode=function(obj,container){var className=Konva.Node.prototype.getClassName.call(obj),children=obj.children,no,len,n;if(container){obj.attrs.container=container}no=new Konva[className](obj.attrs);if(children){len=children.length;for(n=0;n<len;n++){no.add(this._createNode(children[n]))}}return no};Konva.Factory.addOverloadedGetterSetter(Konva.Node,"position");Konva.Factory.addGetterSetter(Konva.Node,"x",0);Konva.Factory.addGetterSetter(Konva.Node,"y",0);Konva.Factory.addGetterSetter(Konva.Node,"opacity",1);Konva.Factory.addGetter(Konva.Node,"name");Konva.Factory.addOverloadedGetterSetter(Konva.Node,"name");Konva.Factory.addGetter(Konva.Node,"id");Konva.Factory.addOverloadedGetterSetter(Konva.Node,"id");Konva.Factory.addGetterSetter(Konva.Node,"rotation",0);Konva.Factory.addComponentsGetterSetter(Konva.Node,"scale",["x","y"]);Konva.Factory.addGetterSetter(Konva.Node,"scaleX",1);Konva.Factory.addGetterSetter(Konva.Node,"scaleY",1);Konva.Factory.addComponentsGetterSetter(Konva.Node,"skew",["x","y"]);Konva.Factory.addGetterSetter(Konva.Node,"skewX",0);Konva.Factory.addGetterSetter(Konva.Node,"skewY",0);Konva.Factory.addComponentsGetterSetter(Konva.Node,"offset",["x","y"]);Konva.Factory.addGetterSetter(Konva.Node,"offsetX",0);Konva.Factory.addGetterSetter(Konva.Node,"offsetY",0);Konva.Factory.addSetter(Konva.Node,"dragDistance");Konva.Factory.addOverloadedGetterSetter(Konva.Node,"dragDistance");Konva.Factory.addSetter(Konva.Node,"width",0);Konva.Factory.addOverloadedGetterSetter(Konva.Node,"width");Konva.Factory.addSetter(Konva.Node,"height",0);Konva.Factory.addOverloadedGetterSetter(Konva.Node,"height");Konva.Factory.addGetterSetter(Konva.Node,"listening","inherit");Konva.Factory.addGetterSetter(Konva.Node,"filters",undefined,function(val){this._filterUpToDate=false;return val});Konva.Factory.addGetterSetter(Konva.Node,"visible","inherit");Konva.Factory.addGetterSetter(Konva.Node,"transformsEnabled","all");Konva.Factory.addOverloadedGetterSetter(Konva.Node,"size");Konva.Factory.backCompat(Konva.Node,{rotateDeg:"rotate",setRotationDeg:"setRotation",getRotationDeg:"getRotation"});Konva.Collection.mapMethods(Konva.Node)})(Konva);(function(){"use strict";Konva.Filters.Grayscale=function(imageData){var data=imageData.data,len=data.length,i,brightness;for(i=0;i<len;i+=4){brightness=.34*data[i]+.5*data[i+1]+.16*data[i+2];data[i]=brightness;data[i+1]=brightness;data[i+2]=brightness}}})();(function(){"use strict";Konva.Filters.Brighten=function(imageData){var brightness=this.brightness()*255,data=imageData.data,len=data.length,i;for(i=0;i<len;i+=4){data[i]+=brightness;data[i+1]+=brightness;data[i+2]+=brightness}};Konva.Factory.addGetterSetter(Konva.Node,"brightness",0,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";Konva.Filters.Invert=function(imageData){var data=imageData.data,len=data.length,i;for(i=0;i<len;i+=4){data[i]=255-data[i];data[i+1]=255-data[i+1];data[i+2]=255-data[i+2]}}})();(function(){"use strict";function BlurStack(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null}var mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];var shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function filterGaussBlurRGBA(imageData,radius){var pixels=imageData.data,width=imageData.width,height=imageData.height;var x,y,i,p,yp,yi,yw,r_sum,g_sum,b_sum,a_sum,r_out_sum,g_out_sum,b_out_sum,a_out_sum,r_in_sum,g_in_sum,b_in_sum,a_in_sum,pr,pg,pb,pa,rbs;var div=radius+radius+1,widthMinus1=width-1,heightMinus1=height-1,radiusPlus1=radius+1,sumFactor=radiusPlus1*(radiusPlus1+1)/2,stackStart=new BlurStack,stackEnd=null,stack=stackStart,stackIn=null,stackOut=null,mul_sum=mul_table[radius],shg_sum=shg_table[radius];for(i=1;i<div;i++){stack=stack.next=new BlurStack;if(i===radiusPlus1){stackEnd=stack}}stack.next=stackStart;yw=yi=0;for(y=0;y<height;y++){r_in_sum=g_in_sum=b_in_sum=a_in_sum=r_sum=g_sum=b_sum=a_sum=0;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);a_out_sum=radiusPlus1*(pa=pixels[yi+3]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;a_sum+=sumFactor*pa;stack=stackStart;for(i=0;i<radiusPlus1;i++){stack.r=pr;stack.g=pg;stack.b=pb;stack.a=pa;stack=stack.next}for(i=1;i<radiusPlus1;i++){p=yi+((widthMinus1<i?widthMinus1:i)<<2);r_sum+=(stack.r=pr=pixels[p])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[p+1])*rbs;b_sum+=(stack.b=pb=pixels[p+2])*rbs;a_sum+=(stack.a=pa=pixels[p+3])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;a_in_sum+=pa;stack=stack.next}stackIn=stackStart;stackOut=stackEnd;for(x=0;x<width;x++){pixels[yi+3]=pa=a_sum*mul_sum>>shg_sum;if(pa!==0){pa=255/pa;pixels[yi]=(r_sum*mul_sum>>shg_sum)*pa;pixels[yi+1]=(g_sum*mul_sum>>shg_sum)*pa;pixels[yi+2]=(b_sum*mul_sum>>shg_sum)*pa}else{pixels[yi]=pixels[yi+1]=pixels[yi+2]=0}r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;a_sum-=a_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;a_out_sum-=stackIn.a;p=yw+((p=x+radius+1)<widthMinus1?p:widthMinus1)<<2;r_in_sum+=stackIn.r=pixels[p];g_in_sum+=stackIn.g=pixels[p+1];b_in_sum+=stackIn.b=pixels[p+2];a_in_sum+=stackIn.a=pixels[p+3];r_sum+=r_in_sum;g_sum+=g_in_sum;b_sum+=b_in_sum;a_sum+=a_in_sum;stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;a_out_sum+=pa=stackOut.a;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;a_in_sum-=pa;stackOut=stackOut.next;yi+=4}yw+=width}for(x=0;x<width;x++){g_in_sum=b_in_sum=a_in_sum=r_in_sum=g_sum=b_sum=a_sum=r_sum=0;yi=x<<2;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);a_out_sum=radiusPlus1*(pa=pixels[yi+3]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;a_sum+=sumFactor*pa;stack=stackStart;for(i=0;i<radiusPlus1;i++){stack.r=pr;stack.g=pg;stack.b=pb;stack.a=pa;stack=stack.next}yp=width;for(i=1;i<=radius;i++){yi=yp+x<<2;r_sum+=(stack.r=pr=pixels[yi])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[yi+1])*rbs;b_sum+=(stack.b=pb=pixels[yi+2])*rbs;a_sum+=(stack.a=pa=pixels[yi+3])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;a_in_sum+=pa;stack=stack.next;if(i<heightMinus1){yp+=width}}yi=x;stackIn=stackStart;stackOut=stackEnd;for(y=0;y<height;y++){p=yi<<2;pixels[p+3]=pa=a_sum*mul_sum>>shg_sum;if(pa>0){pa=255/pa;pixels[p]=(r_sum*mul_sum>>shg_sum)*pa;pixels[p+1]=(g_sum*mul_sum>>shg_sum)*pa;pixels[p+2]=(b_sum*mul_sum>>shg_sum)*pa}else{pixels[p]=pixels[p+1]=pixels[p+2]=0}r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;a_sum-=a_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;a_out_sum-=stackIn.a;p=x+((p=y+radiusPlus1)<heightMinus1?p:heightMinus1)*width<<2;r_sum+=r_in_sum+=stackIn.r=pixels[p];g_sum+=g_in_sum+=stackIn.g=pixels[p+1];b_sum+=b_in_sum+=stackIn.b=pixels[p+2];a_sum+=a_in_sum+=stackIn.a=pixels[p+3];stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;a_out_sum+=pa=stackOut.a;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;a_in_sum-=pa;stackOut=stackOut.next;yi+=width}}}Konva.Filters.Blur=function Blur(imageData){var radius=Math.round(this.blurRadius());if(radius>0){filterGaussBlurRGBA(imageData,radius)}};Konva.Factory.addGetterSetter(Konva.Node,"blurRadius",0,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";function pixelAt(idata,x,y){var idx=(y*idata.width+x)*4;
var d=[];d.push(idata.data[idx++],idata.data[idx++],idata.data[idx++],idata.data[idx++]);return d}function rgbDistance(p1,p2){return Math.sqrt(Math.pow(p1[0]-p2[0],2)+Math.pow(p1[1]-p2[1],2)+Math.pow(p1[2]-p2[2],2))}function rgbMean(pTab){var m=[0,0,0];for(var i=0;i<pTab.length;i++){m[0]+=pTab[i][0];m[1]+=pTab[i][1];m[2]+=pTab[i][2]}m[0]/=pTab.length;m[1]/=pTab.length;m[2]/=pTab.length;return m}function backgroundMask(idata,threshold){var rgbv_no=pixelAt(idata,0,0);var rgbv_ne=pixelAt(idata,idata.width-1,0);var rgbv_so=pixelAt(idata,0,idata.height-1);var rgbv_se=pixelAt(idata,idata.width-1,idata.height-1);var thres=threshold||10;if(rgbDistance(rgbv_no,rgbv_ne)<thres&&rgbDistance(rgbv_ne,rgbv_se)<thres&&rgbDistance(rgbv_se,rgbv_so)<thres&&rgbDistance(rgbv_so,rgbv_no)<thres){var mean=rgbMean([rgbv_ne,rgbv_no,rgbv_se,rgbv_so]);var mask=[];for(var i=0;i<idata.width*idata.height;i++){var d=rgbDistance(mean,[idata.data[i*4],idata.data[i*4+1],idata.data[i*4+2]]);mask[i]=d<thres?0:255}return mask}}function applyMask(idata,mask){for(var i=0;i<idata.width*idata.height;i++){idata.data[4*i+3]=mask[i]}}function erodeMask(mask,sw,sh){var weights=[1,1,1,1,0,1,1,1,1];var side=Math.round(Math.sqrt(weights.length));var halfSide=Math.floor(side/2);var maskResult=[];for(var y=0;y<sh;y++){for(var x=0;x<sw;x++){var so=y*sw+x;var a=0;for(var cy=0;cy<side;cy++){for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide;var scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff=scy*sw+scx;var wt=weights[cy*side+cx];a+=mask[srcOff]*wt}}}maskResult[so]=a===255*8?255:0}}return maskResult}function dilateMask(mask,sw,sh){var weights=[1,1,1,1,1,1,1,1,1];var side=Math.round(Math.sqrt(weights.length));var halfSide=Math.floor(side/2);var maskResult=[];for(var y=0;y<sh;y++){for(var x=0;x<sw;x++){var so=y*sw+x;var a=0;for(var cy=0;cy<side;cy++){for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide;var scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff=scy*sw+scx;var wt=weights[cy*side+cx];a+=mask[srcOff]*wt}}}maskResult[so]=a>=255*4?255:0}}return maskResult}function smoothEdgeMask(mask,sw,sh){var weights=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9];var side=Math.round(Math.sqrt(weights.length));var halfSide=Math.floor(side/2);var maskResult=[];for(var y=0;y<sh;y++){for(var x=0;x<sw;x++){var so=y*sw+x;var a=0;for(var cy=0;cy<side;cy++){for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide;var scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff=scy*sw+scx;var wt=weights[cy*side+cx];a+=mask[srcOff]*wt}}}maskResult[so]=a}}return maskResult}Konva.Filters.Mask=function(imageData){var threshold=this.threshold(),mask=backgroundMask(imageData,threshold);if(mask){mask=erodeMask(mask,imageData.width,imageData.height);mask=dilateMask(mask,imageData.width,imageData.height);mask=smoothEdgeMask(mask,imageData.width,imageData.height);applyMask(imageData,mask)}return imageData};Konva.Factory.addGetterSetter(Konva.Node,"threshold",0,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";Konva.Filters.RGB=function(imageData){var data=imageData.data,nPixels=data.length,red=this.red(),green=this.green(),blue=this.blue(),i,brightness;for(i=0;i<nPixels;i+=4){brightness=(.34*data[i]+.5*data[i+1]+.16*data[i+2])/255;data[i]=brightness*red;data[i+1]=brightness*green;data[i+2]=brightness*blue;data[i+3]=data[i+3]}};Konva.Factory.addGetterSetter(Konva.Node,"red",0,function(val){this._filterUpToDate=false;if(val>255){return 255}else if(val<0){return 0}else{return Math.round(val)}});Konva.Factory.addGetterSetter(Konva.Node,"green",0,function(val){this._filterUpToDate=false;if(val>255){return 255}else if(val<0){return 0}else{return Math.round(val)}});Konva.Factory.addGetterSetter(Konva.Node,"blue",0,Konva.Validators.RGBComponent,Konva.Factory.afterSetFilter)})();(function(){"use strict";Konva.Filters.RGBA=function(imageData){var data=imageData.data,nPixels=data.length,red=this.red(),green=this.green(),blue=this.blue(),alpha=this.alpha(),i,ia;for(i=0;i<nPixels;i+=4){ia=1-alpha;data[i]=red*alpha+data[i]*ia;data[i+1]=green*alpha+data[i+1]*ia;data[i+2]=blue*alpha+data[i+2]*ia}};Konva.Factory.addGetterSetter(Konva.Node,"red",0,function(val){this._filterUpToDate=false;if(val>255){return 255}else if(val<0){return 0}else{return Math.round(val)}});Konva.Factory.addGetterSetter(Konva.Node,"green",0,function(val){this._filterUpToDate=false;if(val>255){return 255}else if(val<0){return 0}else{return Math.round(val)}});Konva.Factory.addGetterSetter(Konva.Node,"blue",0,Konva.Validators.RGBComponent,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,"alpha",1,function(val){this._filterUpToDate=false;if(val>1){return 1}else if(val<0){return 0}else{return val}})})();(function(){"use strict";Konva.Filters.HSV=function(imageData){var data=imageData.data,nPixels=data.length,v=Math.pow(2,this.value()),s=Math.pow(2,this.saturation()),h=Math.abs(this.hue()+360)%360,i;var vsu=v*s*Math.cos(h*Math.PI/180),vsw=v*s*Math.sin(h*Math.PI/180);var rr=.299*v+.701*vsu+.167*vsw,rg=.587*v-.587*vsu+.33*vsw,rb=.114*v-.114*vsu-.497*vsw;var gr=.299*v-.299*vsu-.328*vsw,gg=.587*v+.413*vsu+.035*vsw,gb=.114*v-.114*vsu+.293*vsw;var br=.299*v-.3*vsu+1.25*vsw,bg=.587*v-.586*vsu-1.05*vsw,bb=.114*v+.886*vsu-.2*vsw;var r,g,b,a;for(i=0;i<nPixels;i+=4){r=data[i+0];g=data[i+1];b=data[i+2];a=data[i+3];data[i+0]=rr*r+rg*g+rb*b;data[i+1]=gr*r+gg*g+gb*b;data[i+2]=br*r+bg*g+bb*b;data[i+3]=a}};Konva.Factory.addGetterSetter(Konva.Node,"hue",0,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,"saturation",0,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,"value",0,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";Konva.Factory.addGetterSetter(Konva.Node,"hue",0,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,"saturation",0,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,"luminance",0,null,Konva.Factory.afterSetFilter);Konva.Filters.HSL=function(imageData){var data=imageData.data,nPixels=data.length,v=1,s=Math.pow(2,this.saturation()),h=Math.abs(this.hue()+360)%360,l=this.luminance()*127,i;var vsu=v*s*Math.cos(h*Math.PI/180),vsw=v*s*Math.sin(h*Math.PI/180);var rr=.299*v+.701*vsu+.167*vsw,rg=.587*v-.587*vsu+.33*vsw,rb=.114*v-.114*vsu-.497*vsw;var gr=.299*v-.299*vsu-.328*vsw,gg=.587*v+.413*vsu+.035*vsw,gb=.114*v-.114*vsu+.293*vsw;var br=.299*v-.3*vsu+1.25*vsw,bg=.587*v-.586*vsu-1.05*vsw,bb=.114*v+.886*vsu-.2*vsw;var r,g,b,a;for(i=0;i<nPixels;i+=4){r=data[i+0];g=data[i+1];b=data[i+2];a=data[i+3];data[i+0]=rr*r+rg*g+rb*b+l;data[i+1]=gr*r+gg*g+gb*b+l;data[i+2]=br*r+bg*g+bb*b+l;data[i+3]=a}}})();(function(){"use strict";Konva.Filters.Emboss=function(imageData){var strength=this.embossStrength()*10,greyLevel=this.embossWhiteLevel()*255,direction=this.embossDirection(),blend=this.embossBlend(),dirY=0,dirX=0,data=imageData.data,w=imageData.width,h=imageData.height,w4=w*4,y=h;switch(direction){case"top-left":dirY=-1;dirX=-1;break;case"top":dirY=-1;dirX=0;break;case"top-right":dirY=-1;dirX=1;break;case"right":dirY=0;dirX=1;break;case"bottom-right":dirY=1;dirX=1;break;case"bottom":dirY=1;dirX=0;break;case"bottom-left":dirY=1;dirX=-1;break;case"left":dirY=0;dirX=-1;break}do{var offsetY=(y-1)*w4;var otherY=dirY;if(y+otherY<1){otherY=0}if(y+otherY>h){otherY=0}var offsetYOther=(y-1+otherY)*w*4;var x=w;do{var offset=offsetY+(x-1)*4;var otherX=dirX;if(x+otherX<1){otherX=0}if(x+otherX>w){otherX=0}var offsetOther=offsetYOther+(x-1+otherX)*4;var dR=data[offset]-data[offsetOther];var dG=data[offset+1]-data[offsetOther+1];var dB=data[offset+2]-data[offsetOther+2];var dif=dR;var absDif=dif>0?dif:-dif;var absG=dG>0?dG:-dG;var absB=dB>0?dB:-dB;if(absG>absDif){dif=dG}if(absB>absDif){dif=dB}dif*=strength;if(blend){var r=data[offset]+dif;var g=data[offset+1]+dif;var b=data[offset+2]+dif;data[offset]=r>255?255:r<0?0:r;data[offset+1]=g>255?255:g<0?0:g;data[offset+2]=b>255?255:b<0?0:b}else{var grey=greyLevel-dif;if(grey<0){grey=0}else if(grey>255){grey=255}data[offset]=data[offset+1]=data[offset+2]=grey}}while(--x)}while(--y)};Konva.Factory.addGetterSetter(Konva.Node,"embossStrength",.5,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,"embossWhiteLevel",.5,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,"embossDirection","top-left",null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,"embossBlend",false,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";function remap(fromValue,fromMin,fromMax,toMin,toMax){var fromRange=fromMax-fromMin,toRange=toMax-toMin,toValue;if(fromRange===0){return toMin+toRange/2}if(toRange===0){return toMin}toValue=(fromValue-fromMin)/fromRange;toValue=toRange*toValue+toMin;return toValue}Konva.Filters.Enhance=function(imageData){var data=imageData.data,nSubPixels=data.length,rMin=data[0],rMax=rMin,r,gMin=data[1],gMax=gMin,g,bMin=data[2],bMax=bMin,b,i;var enhanceAmount=this.enhance();if(enhanceAmount===0){return}for(i=0;i<nSubPixels;i+=4){r=data[i+0];if(r<rMin){rMin=r}else if(r>rMax){rMax=r}g=data[i+1];if(g<gMin){gMin=g}else if(g>gMax){gMax=g}b=data[i+2];if(b<bMin){bMin=b}else if(b>bMax){bMax=b}}if(rMax===rMin){rMax=255;rMin=0}if(gMax===gMin){gMax=255;gMin=0}if(bMax===bMin){bMax=255;bMin=0}var rMid,rGoalMax,rGoalMin,gMid,gGoalMax,gGoalMin,bMid,bGoalMax,bGoalMin;if(enhanceAmount>0){rGoalMax=rMax+enhanceAmount*(255-rMax);rGoalMin=rMin-enhanceAmount*(rMin-0);gGoalMax=gMax+enhanceAmount*(255-gMax);gGoalMin=gMin-enhanceAmount*(gMin-0);bGoalMax=bMax+enhanceAmount*(255-bMax);bGoalMin=bMin-enhanceAmount*(bMin-0)}else{rMid=(rMax+rMin)*.5;rGoalMax=rMax+enhanceAmount*(rMax-rMid);rGoalMin=rMin+enhanceAmount*(rMin-rMid);gMid=(gMax+gMin)*.5;gGoalMax=gMax+enhanceAmount*(gMax-gMid);gGoalMin=gMin+enhanceAmount*(gMin-gMid);bMid=(bMax+bMin)*.5;bGoalMax=bMax+enhanceAmount*(bMax-bMid);bGoalMin=bMin+enhanceAmount*(bMin-bMid)}for(i=0;i<nSubPixels;i+=4){data[i+0]=remap(data[i+0],rMin,rMax,rGoalMin,rGoalMax);data[i+1]=remap(data[i+1],gMin,gMax,gGoalMin,gGoalMax);data[i+2]=remap(data[i+2],bMin,bMax,bGoalMin,bGoalMax)}};Konva.Factory.addGetterSetter(Konva.Node,"enhance",0,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";Konva.Filters.Posterize=function(imageData){var levels=Math.round(this.levels()*254)+1,data=imageData.data,len=data.length,scale=255/levels,i;for(i=0;i<len;i+=1){data[i]=Math.floor(data[i]/scale)*scale}};Konva.Factory.addGetterSetter(Konva.Node,"levels",.5,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";Konva.Filters.Noise=function(imageData){var amount=this.noise()*255,data=imageData.data,nPixels=data.length,half=amount/2,i;for(i=0;i<nPixels;i+=4){data[i+0]+=half-2*half*Math.random();data[i+1]+=half-2*half*Math.random();data[i+2]+=half-2*half*Math.random()}};Konva.Factory.addGetterSetter(Konva.Node,"noise",.2,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";Konva.Filters.Pixelate=function(imageData){var pixelSize=Math.ceil(this.pixelSize()),width=imageData.width,height=imageData.height,x,y,i,red,green,blue,alpha,nBinsX=Math.ceil(width/pixelSize),nBinsY=Math.ceil(height/pixelSize),xBinStart,xBinEnd,yBinStart,yBinEnd,xBin,yBin,pixelsInBin;imageData=imageData.data;for(xBin=0;xBin<nBinsX;xBin+=1){for(yBin=0;yBin<nBinsY;yBin+=1){red=0;green=0;blue=0;alpha=0;xBinStart=xBin*pixelSize;xBinEnd=xBinStart+pixelSize;yBinStart=yBin*pixelSize;yBinEnd=yBinStart+pixelSize;pixelsInBin=0;for(x=xBinStart;x<xBinEnd;x+=1){if(x>=width){continue}for(y=yBinStart;y<yBinEnd;y+=1){if(y>=height){continue}i=(width*y+x)*4;red+=imageData[i+0];green+=imageData[i+1];blue+=imageData[i+2];alpha+=imageData[i+3];pixelsInBin+=1}}red=red/pixelsInBin;green=green/pixelsInBin;blue=blue/pixelsInBin;for(x=xBinStart;x<xBinEnd;x+=1){if(x>=width){continue}for(y=yBinStart;y<yBinEnd;y+=1){if(y>=height){continue}i=(width*y+x)*4;imageData[i+0]=red;imageData[i+1]=green;imageData[i+2]=blue;imageData[i+3]=alpha}}}}};Konva.Factory.addGetterSetter(Konva.Node,"pixelSize",8,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";Konva.Filters.Threshold=function(imageData){var level=this.threshold()*255,data=imageData.data,len=data.length,i;for(i=0;i<len;i+=1){data[i]=data[i]<level?0:255}};Konva.Factory.addGetterSetter(Konva.Node,"threshold",.5,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";Konva.Filters.Sepia=function(imageData){var data=imageData.data,w=imageData.width,y=imageData.height,w4=w*4,offsetY,x,offset,or,og,ob,r,g,b;do{offsetY=(y-1)*w4;x=w;do{offset=offsetY+(x-1)*4;or=data[offset];og=data[offset+1];ob=data[offset+2];r=or*.393+og*.769+ob*.189;g=or*.349+og*.686+ob*.168;b=or*.272+og*.534+ob*.131;data[offset]=r>255?255:r;data[offset+1]=g>255?255:g;data[offset+2]=b>255?255:b;data[offset+3]=data[offset+3]}while(--x)}while(--y)}})();(function(){"use strict";Konva.Filters.Solarize=function(imageData){var data=imageData.data,w=imageData.width,h=imageData.height,w4=w*4,y=h;do{var offsetY=(y-1)*w4;var x=w;do{var offset=offsetY+(x-1)*4;var r=data[offset];var g=data[offset+1];var b=data[offset+2];if(r>127){r=255-r}if(g>127){g=255-g}if(b>127){b=255-b}data[offset]=r;data[offset+1]=g;data[offset+2]=b}while(--x)}while(--y)}})();(function(){"use strict";var ToPolar=function(src,dst,opt){var srcPixels=src.data,dstPixels=dst.data,xSize=src.width,ySize=src.height,xMid=opt.polarCenterX||xSize/2,yMid=opt.polarCenterY||ySize/2,i,x,y,r=0,g=0,b=0,a=0;var rad,rMax=Math.sqrt(xMid*xMid+yMid*yMid);x=xSize-xMid;y=ySize-yMid;rad=Math.sqrt(x*x+y*y);rMax=rad>rMax?rad:rMax;var rSize=ySize,tSize=xSize,radius,theta;var conversion=360/tSize*Math.PI/180,sin,cos;for(theta=0;theta<tSize;theta+=1){sin=Math.sin(theta*conversion);cos=Math.cos(theta*conversion);for(radius=0;radius<rSize;radius+=1){x=Math.floor(xMid+rMax*radius/rSize*cos);y=Math.floor(yMid+rMax*radius/rSize*sin);i=(y*xSize+x)*4;r=srcPixels[i+0];g=srcPixels[i+1];b=srcPixels[i+2];a=srcPixels[i+3];i=(theta+radius*xSize)*4;dstPixels[i+0]=r;dstPixels[i+1]=g;dstPixels[i+2]=b;dstPixels[i+3]=a}}};var FromPolar=function(src,dst,opt){var srcPixels=src.data,dstPixels=dst.data,xSize=src.width,ySize=src.height,xMid=opt.polarCenterX||xSize/2,yMid=opt.polarCenterY||ySize/2,i,x,y,dx,dy,r=0,g=0,b=0,a=0;var rad,rMax=Math.sqrt(xMid*xMid+yMid*yMid);x=xSize-xMid;y=ySize-yMid;rad=Math.sqrt(x*x+y*y);rMax=rad>rMax?rad:rMax;var rSize=ySize,tSize=xSize,radius,theta,phaseShift=opt.polarRotation||0;var x1,y1;for(x=0;x<xSize;x+=1){for(y=0;y<ySize;y+=1){dx=x-xMid;dy=y-yMid;radius=Math.sqrt(dx*dx+dy*dy)*rSize/rMax;theta=(Math.atan2(dy,dx)*180/Math.PI+360+phaseShift)%360;theta=theta*tSize/360;x1=Math.floor(theta);y1=Math.floor(radius);i=(y1*xSize+x1)*4;r=srcPixels[i+0];g=srcPixels[i+1];b=srcPixels[i+2];a=srcPixels[i+3];i=(y*xSize+x)*4;dstPixels[i+0]=r;dstPixels[i+1]=g;dstPixels[i+2]=b;dstPixels[i+3]=a}}};var tempCanvas=Konva.Util.createCanvasElement();Konva.Filters.Kaleidoscope=function(imageData){var xSize=imageData.width,ySize=imageData.height;var x,y,xoff,i,r,g,b,a,srcPos,dstPos;var power=Math.round(this.kaleidoscopePower());var angle=Math.round(this.kaleidoscopeAngle());var offset=Math.floor(xSize*(angle%360)/360);if(power<1){return}tempCanvas.width=xSize;tempCanvas.height=ySize;var scratchData=tempCanvas.getContext("2d").getImageData(0,0,xSize,ySize);ToPolar(imageData,scratchData,{polarCenterX:xSize/2,polarCenterY:ySize/2});var minSectionSize=xSize/Math.pow(2,power);while(minSectionSize<=8){minSectionSize=minSectionSize*2;power-=1}minSectionSize=Math.ceil(minSectionSize);var sectionSize=minSectionSize;var xStart=0,xEnd=sectionSize,xDelta=1;if(offset+minSectionSize>xSize){xStart=sectionSize;xEnd=0;xDelta=-1}for(y=0;y<ySize;y+=1){for(x=xStart;x!==xEnd;x+=xDelta){xoff=Math.round(x+offset)%xSize;srcPos=(xSize*y+xoff)*4;r=scratchData.data[srcPos+0];g=scratchData.data[srcPos+1];b=scratchData.data[srcPos+2];a=scratchData.data[srcPos+3];dstPos=(xSize*y+x)*4;scratchData.data[dstPos+0]=r;scratchData.data[dstPos+1]=g;scratchData.data[dstPos+2]=b;scratchData.data[dstPos+3]=a}}for(y=0;y<ySize;y+=1){sectionSize=Math.floor(minSectionSize);for(i=0;i<power;i+=1){for(x=0;x<sectionSize+1;x+=1){srcPos=(xSize*y+x)*4;r=scratchData.data[srcPos+0];g=scratchData.data[srcPos+1];b=scratchData.data[srcPos+2];a=scratchData.data[srcPos+3];dstPos=(xSize*y+sectionSize*2-x-1)*4;scratchData.data[dstPos+0]=r;scratchData.data[dstPos+1]=g;scratchData.data[dstPos+2]=b;scratchData.data[dstPos+3]=a}sectionSize*=2}}FromPolar(scratchData,imageData,{polarRotation:0})};Konva.Factory.addGetterSetter(Konva.Node,"kaleidoscopePower",2,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,"kaleidoscopeAngle",0,null,Konva.Factory.afterSetFilter)})();(function(){"use strict";Konva.Container=function(config){this.__init(config)};Konva.Util.addMethods(Konva.Container,{__init:function(config){this.children=new Konva.Collection;Konva.Node.call(this,config)},getChildren:function(filterFunc){if(!filterFunc){return this.children}var results=new Konva.Collection;this.children.each(function(child){if(filterFunc(child)){results.push(child)}});return results},hasChildren:function(){return this.getChildren().length>0},removeChildren:function(){var children=Konva.Collection.toCollection(this.children);var child;for(var i=0;i<children.length;i++){child=children[i];delete child.parent;child.index=0;child.remove()}children=null;this.children=new Konva.Collection;return this},destroyChildren:function(){var children=Konva.Collection.toCollection(this.children);var child;for(var i=0;i<children.length;i++){child=children[i];delete child.parent;child.index=0;child.destroy()}children=null;this.children=new Konva.Collection;return this},add:function(child){if(arguments.length>1){for(var i=0;i<arguments.length;i++){this.add(arguments[i])}return this}if(child.getParent()){child.moveTo(this);return this}var children=this.children;this._validateAdd(child);child.index=children.length;child.parent=this;children.push(child);this._fire("add",{child:child});if(Konva.DD&&child.isDragging()){Konva.DD.anim.setLayers(child.getLayer())}return this},destroy:function(){if(this.hasChildren()){this.destroyChildren()}Konva.Node.prototype.destroy.call(this);return this},find:function(selector){var retArr=[],selectorArr=selector.replace(/ /g,"").split(","),len=selectorArr.length,n,i,sel,arr,node,children,clen;for(n=0;n<len;n++){sel=selectorArr[n];if(!Konva.Util.isValidSelector(sel)){Konva.Util.warn('Selector "'+sel+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".');Konva.Util.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".');Konva.Util.warn("Konva is awesome, right?")}if(sel.charAt(0)==="#"){node=this._getNodeById(sel.slice(1));if(node){retArr.push(node)}}else if(sel.charAt(0)==="."){arr=this._getNodesByName(sel.slice(1));retArr=retArr.concat(arr)}else{children=this.getChildren();clen=children.length;for(i=0;i<clen;i++){retArr=retArr.concat(children[i]._get(sel))}}}return Konva.Collection.toCollection(retArr)},findOne:function(selector){return this.find(selector)[0]},_getNodeById:function(key){var node=Konva.ids[key];if(node!==undefined&&this.isAncestorOf(node)){return node}return null},_getNodesByName:function(key){var arr=Konva.names[key]||[];return this._getDescendants(arr)},_get:function(selector){var retArr=Konva.Node.prototype._get.call(this,selector);var children=this.getChildren();var len=children.length;for(var n=0;n<len;n++){retArr=retArr.concat(children[n]._get(selector))}return retArr},toObject:function(){var obj=Konva.Node.prototype.toObject.call(this);obj.children=[];var children=this.getChildren();var len=children.length;for(var n=0;n<len;n++){var child=children[n];obj.children.push(child.toObject())}return obj},_getDescendants:function(arr){var retArr=[];var len=arr.length;for(var n=0;n<len;n++){var node=arr[n];if(this.isAncestorOf(node)){retArr.push(node)}}return retArr},isAncestorOf:function(node){var parent=node.getParent();while(parent){if(parent._id===this._id){return true}parent=parent.getParent()}return false},clone:function(obj){var node=Konva.Node.prototype.clone.call(this,obj);this.getChildren().each(function(no){node.add(no.clone())});return node},getAllIntersections:function(pos){var arr=[];this.find("Shape").each(function(shape){if(shape.isVisible()&&shape.intersects(pos)){arr.push(shape)}});return arr},_setChildrenIndices:function(){this.children.each(function(child,n){child.index=n})},drawScene:function(can,top,caching){var layer=this.getLayer(),canvas=can||layer&&layer.getCanvas(),context=canvas&&canvas.getContext(),cachedCanvas=this._cache.canvas,cachedSceneCanvas=cachedCanvas&&cachedCanvas.scene;if(this.isVisible()){if(!caching&&cachedSceneCanvas){context.save();layer._applyTransform(this,context,top);this._drawCachedSceneCanvas(context);context.restore()}else{this._drawChildren(canvas,"drawScene",top,false,caching)}}return this},drawHit:function(can,top,caching){var layer=this.getLayer(),canvas=can||layer&&layer.hitCanvas,context=canvas&&canvas.getContext(),cachedCanvas=this._cache.canvas,cachedHitCanvas=cachedCanvas&&cachedCanvas.hit;if(this.shouldDrawHit(canvas)){if(layer){layer.clearHitCache()}if(!caching&&cachedHitCanvas){context.save();layer._applyTransform(this,context,top);this._drawCachedHitCanvas(context);context.restore()}else{this._drawChildren(canvas,"drawHit",top)}}return this},_drawChildren:function(canvas,drawMethod,top,caching,skipBuffer){var layer=this.getLayer(),context=canvas&&canvas.getContext(),clipWidth=this.getClipWidth(),clipHeight=this.getClipHeight(),clipFunc=this.getClipFunc(),hasClip=clipWidth&&clipHeight||clipFunc,clipX,clipY;if(hasClip&&layer){context.save();layer._applyTransform(this,context);context.beginPath();if(clipFunc){clipFunc.call(this,context,this)}else{clipX=this.getClipX();clipY=this.getClipY();context.rect(clipX,clipY,clipWidth,clipHeight)}context.clip();context.reset()}this.children.each(function(child){child[drawMethod](canvas,top,caching,skipBuffer)});if(hasClip){context.restore()}},shouldDrawHit:function(canvas){var layer=this.getLayer();var dd=Konva.DD;var layerUnderDrag=dd&&Konva.isDragging()&&Konva.DD.anim.getLayers().indexOf(layer)!==-1;return canvas&&canvas.isCache||layer&&layer.hitGraphEnabled()&&this.isVisible()&&!layerUnderDrag},getClientRect:function(skipTransform){var minX,minY,maxX,maxY;var selfRect={x:0,y:0,width:0,height:0};this.children.each(function(child){var rect=child.getClientRect();if(minX===undefined){minX=rect.x;minY=rect.y;maxX=rect.x+rect.width;maxY=rect.y+rect.height}else{minX=Math.min(minX,rect.x);minY=Math.min(minY,rect.y);maxX=Math.max(maxX,rect.x+rect.width);maxY=Math.max(maxY,rect.y+rect.height)}});if(this.children.length!==0){selfRect={x:minX,y:minY,width:maxX-minX,height:maxY-minY}}if(!skipTransform){return this._transformedRect(selfRect)}return selfRect}});Konva.Util.extend(Konva.Container,Konva.Node);Konva.Container.prototype.get=Konva.Container.prototype.find;Konva.Factory.addComponentsGetterSetter(Konva.Container,"clip",["x","y","width","height"]);Konva.Factory.addGetterSetter(Konva.Container,"clipX");Konva.Factory.addGetterSetter(Konva.Container,"clipY");Konva.Factory.addGetterSetter(Konva.Container,"clipWidth");Konva.Factory.addGetterSetter(Konva.Container,"clipHeight");Konva.Factory.addGetterSetter(Konva.Container,"clipFunc");Konva.Collection.mapMethods(Konva.Container)})();(function(Konva){"use strict";var HAS_SHADOW="hasShadow";var SHADOW_RGBA="shadowRGBA";function _fillFunc(context){context.fill()}function _strokeFunc(context){context.stroke()}function _fillFuncHit(context){context.fill()}function _strokeFuncHit(context){context.stroke()}function _clearHasShadowCache(){this._clearCache(HAS_SHADOW)}function _clearGetShadowRGBACache(){this._clearCache(SHADOW_RGBA)}Konva.Shape=function(config){this.__init(config)};Konva.Util.addMethods(Konva.Shape,{__init:function(config){this.nodeType="Shape";this._fillFunc=_fillFunc;this._strokeFunc=_strokeFunc;this._fillFuncHit=_fillFuncHit;this._strokeFuncHit=_strokeFuncHit;var shapes=Konva.shapes;var key;while(true){key=Konva.Util.getRandomColor();if(key&&!(key in shapes)){break}}this.colorKey=key;shapes[key]=this;Konva.Node.call(this,config);this.on("shadowColorChange.konva shadowBlurChange.konva shadowOffsetChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",_clearHasShadowCache);this.on("shadowColorChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",_clearGetShadowRGBACache)},hasChildren:function(){return false},getChildren:function(){return[]},getContext:function(){return this.getLayer().getContext()},getCanvas:function(){return this.getLayer().getCanvas()},hasShadow:function(){return this._getCache(HAS_SHADOW,this._hasShadow)},_hasShadow:function(){return this.getShadowEnabled()&&(this.getShadowOpacity()!==0&&!!(this.getShadowColor()||this.getShadowBlur()||this.getShadowOffsetX()||this.getShadowOffsetY()))},getShadowRGBA:function(){return this._getCache(SHADOW_RGBA,this._getShadowRGBA)},_getShadowRGBA:function(){if(this.hasShadow()){var rgba=Konva.Util.colorToRGBA(this.shadowColor());return"rgba("+rgba.r+","+rgba.g+","+rgba.b+","+rgba.a*(this.getShadowOpacity()||1)+")"}},hasFill:function(){return!!(this.getFill()||this.getFillPatternImage()||this.getFillLinearGradientColorStops()||this.getFillRadialGradientColorStops())},hasStroke:function(){return!!this.stroke()},intersects:function(point){var stage=this.getStage(),bufferHitCanvas=stage.bufferHitCanvas,p;bufferHitCanvas.getContext().clear();this.drawScene(bufferHitCanvas);p=bufferHitCanvas.context.getImageData(Math.round(point.x),Math.round(point.y),1,1).data;return p[3]>0},destroy:function(){Konva.Node.prototype.destroy.call(this);delete Konva.shapes[this.colorKey];return this},_useBufferCanvas:function(caching){return!caching&&(this.perfectDrawEnabled()&&this.getAbsoluteOpacity()!==1&&this.hasFill()&&this.hasStroke()&&this.getStage())||this.perfectDrawEnabled()&&this.hasShadow()&&this.getAbsoluteOpacity()!==1&&this.hasFill()&&this.hasStroke()&&this.getStage()},getSelfRect:function(){var size=this.getSize();return{x:this._centroid?Math.round(-size.width/2):0,y:this._centroid?Math.round(-size.height/2):0,width:size.width,height:size.height}},getClientRect:function(skipTransform){var fillRect=this.getSelfRect();var strokeWidth=this.hasStroke()&&this.strokeWidth()||0;var fillAndStrokeWidth=fillRect.width+strokeWidth;var fillAndStrokeHeight=fillRect.height+strokeWidth;var shadowOffsetX=this.shadowOffsetX();var shadowOffsetY=this.shadowOffsetY();var preWidth=fillAndStrokeWidth+Math.abs(shadowOffsetX);var preHeight=fillAndStrokeHeight+Math.abs(shadowOffsetY);var blurRadius=this.hasShadow()&&this.shadowBlur()||0;var width=preWidth+blurRadius*2;var height=preHeight+blurRadius*2;var roundingOffset=0;if(Math.round(strokeWidth/2)!==strokeWidth/2){roundingOffset=1}var rect={width:width+roundingOffset,height:height+roundingOffset,x:-Math.round(strokeWidth/2+blurRadius)+Math.min(shadowOffsetX,0)+fillRect.x,y:-Math.round(strokeWidth/2+blurRadius)+Math.min(shadowOffsetY,0)+fillRect.y};if(!skipTransform){return this._transformedRect(rect)}return rect},drawScene:function(can,top,caching,skipBuffer){var layer=this.getLayer(),canvas=can||layer.getCanvas(),context=canvas.getContext(),cachedCanvas=this._cache.canvas,drawFunc=this.sceneFunc(),hasShadow=this.hasShadow(),hasStroke=this.hasStroke(),stage,bufferCanvas,bufferContext;if(!this.isVisible()){return this}if(cachedCanvas){context.save();layer._applyTransform(this,context,top);this._drawCachedSceneCanvas(context);context.restore();return this}if(!drawFunc){return this}context.save();if(this._useBufferCanvas(caching)&&!skipBuffer){stage=this.getStage();bufferCanvas=stage.bufferCanvas;bufferContext=bufferCanvas.getContext();bufferContext.clear();bufferContext.save();bufferContext._applyLineJoin(this);if(!caching){if(layer){layer._applyTransform(this,bufferContext,top)}else{var m=this.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5])}}drawFunc.call(this,bufferContext);bufferContext.restore();var ratio=bufferCanvas.pixelRatio;if(hasShadow&&!canvas.hitCanvas){context.save();context._applyShadow(this);context._applyOpacity(this);context.drawImage(bufferCanvas._canvas,0,0,bufferCanvas.width/ratio,bufferCanvas.height/ratio);context.restore()}else{context._applyOpacity(this);context.drawImage(bufferCanvas._canvas,0,0,bufferCanvas.width/ratio,bufferCanvas.height/ratio)}}else{context._applyLineJoin(this);if(!caching){if(layer){layer._applyTransform(this,context,top)}else{var o=this.getAbsoluteTransform(top).getMatrix();context.transform(o[0],o[1],o[2],o[3],o[4],o[5])}}if(hasShadow&&hasStroke&&!canvas.hitCanvas){context.save();if(!caching){context._applyOpacity(this)}context._applyShadow(this);drawFunc.call(this,context);context.restore();if(this.hasFill()&&this.getShadowForStrokeEnabled()){drawFunc.call(this,context)}}else if(hasShadow&&!canvas.hitCanvas){context.save();if(!caching){context._applyOpacity(this)}context._applyShadow(this);drawFunc.call(this,context);context.restore()}else{if(!caching){context._applyOpacity(this)}drawFunc.call(this,context)}}context.restore();return this},drawHit:function(can,top,caching){var layer=this.getLayer(),canvas=can||layer.hitCanvas,context=canvas.getContext(),drawFunc=this.hitFunc()||this.sceneFunc(),cachedCanvas=this._cache.canvas,cachedHitCanvas=cachedCanvas&&cachedCanvas.hit;if(!this.shouldDrawHit(canvas)){return this}if(layer){layer.clearHitCache()}if(cachedHitCanvas){context.save();layer._applyTransform(this,context,top);this._drawCachedHitCanvas(context);context.restore();return this}if(!drawFunc){return this}context.save();context._applyLineJoin(this);if(!caching){if(layer){layer._applyTransform(this,context,top)}else{var o=this.getAbsoluteTransform(top).getMatrix();context.transform(o[0],o[1],o[2],o[3],o[4],o[5])}}drawFunc.call(this,context);context.restore();return this},drawHitFromCache:function(alphaThreshold){var threshold=alphaThreshold||0,cachedCanvas=this._cache.canvas,sceneCanvas=this._getCachedSceneCanvas(),hitCanvas=cachedCanvas.hit,hitContext=hitCanvas.getContext(),hitWidth=hitCanvas.getWidth(),hitHeight=hitCanvas.getHeight(),hitImageData,hitData,len,rgbColorKey,i,alpha;hitContext.clear();hitContext.drawImage(sceneCanvas._canvas,0,0,hitWidth,hitHeight);try{hitImageData=hitContext.getImageData(0,0,hitWidth,hitHeight);hitData=hitImageData.data;len=hitData.length;rgbColorKey=Konva.Util._hexToRgb(this.colorKey);for(i=0;i<len;i+=4){alpha=hitData[i+3];if(alpha>threshold){hitData[i]=rgbColorKey.r;hitData[i+1]=rgbColorKey.g;hitData[i+2]=rgbColorKey.b;hitData[i+3]=255}else{hitData[i+3]=0}}hitContext.putImageData(hitImageData,0,0)}catch(e){Konva.Util.error("Unable to draw hit graph from cached scene canvas. "+e.message)}return this}});Konva.Util.extend(Konva.Shape,Konva.Node);Konva.Factory.addGetterSetter(Konva.Shape,"stroke");Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"strokeRed",0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"strokeGreen",0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"strokeBlue",0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"strokeAlpha",1,Konva.Validators.alphaComponent);Konva.Factory.addGetterSetter(Konva.Shape,"strokeWidth",2);Konva.Factory.addGetterSetter(Konva.Shape,"strokeHitEnabled",true);Konva.Factory.addGetterSetter(Konva.Shape,"perfectDrawEnabled",true);Konva.Factory.addGetterSetter(Konva.Shape,"shadowForStrokeEnabled",true);Konva.Factory.addGetterSetter(Konva.Shape,"lineJoin");Konva.Factory.addGetterSetter(Konva.Shape,"lineCap");Konva.Factory.addGetterSetter(Konva.Shape,"sceneFunc");Konva.Factory.addGetterSetter(Konva.Shape,"hitFunc");Konva.Factory.addGetterSetter(Konva.Shape,"dash");Konva.Factory.addGetterSetter(Konva.Shape,"shadowColor");Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"shadowRed",0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"shadowGreen",0,Konva.Validators.RGBComponent);
Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"shadowBlue",0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"shadowAlpha",1,Konva.Validators.alphaComponent);Konva.Factory.addGetterSetter(Konva.Shape,"shadowBlur");Konva.Factory.addGetterSetter(Konva.Shape,"shadowOpacity");Konva.Factory.addComponentsGetterSetter(Konva.Shape,"shadowOffset",["x","y"]);Konva.Factory.addGetterSetter(Konva.Shape,"shadowOffsetX",0);Konva.Factory.addGetterSetter(Konva.Shape,"shadowOffsetY",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillPatternImage");Konva.Factory.addGetterSetter(Konva.Shape,"fill");Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"fillRed",0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"fillGreen",0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"fillBlue",0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,"fillAlpha",1,Konva.Validators.alphaComponent);Konva.Factory.addGetterSetter(Konva.Shape,"fillPatternX",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillPatternY",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillLinearGradientColorStops");Konva.Factory.addGetterSetter(Konva.Shape,"fillRadialGradientStartRadius",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillRadialGradientEndRadius",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillRadialGradientColorStops");Konva.Factory.addGetterSetter(Konva.Shape,"fillPatternRepeat","repeat");Konva.Factory.addGetterSetter(Konva.Shape,"fillEnabled",true);Konva.Factory.addGetterSetter(Konva.Shape,"strokeEnabled",true);Konva.Factory.addGetterSetter(Konva.Shape,"shadowEnabled",true);Konva.Factory.addGetterSetter(Konva.Shape,"dashEnabled",true);Konva.Factory.addGetterSetter(Konva.Shape,"strokeScaleEnabled",true);Konva.Factory.addGetterSetter(Konva.Shape,"fillPriority","color");Konva.Factory.addComponentsGetterSetter(Konva.Shape,"fillPatternOffset",["x","y"]);Konva.Factory.addGetterSetter(Konva.Shape,"fillPatternOffsetX",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillPatternOffsetY",0);Konva.Factory.addComponentsGetterSetter(Konva.Shape,"fillPatternScale",["x","y"]);Konva.Factory.addGetterSetter(Konva.Shape,"fillPatternScaleX",1);Konva.Factory.addGetterSetter(Konva.Shape,"fillPatternScaleY",1);Konva.Factory.addComponentsGetterSetter(Konva.Shape,"fillLinearGradientStartPoint",["x","y"]);Konva.Factory.addGetterSetter(Konva.Shape,"fillLinearGradientStartPointX",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillLinearGradientStartPointY",0);Konva.Factory.addComponentsGetterSetter(Konva.Shape,"fillLinearGradientEndPoint",["x","y"]);Konva.Factory.addGetterSetter(Konva.Shape,"fillLinearGradientEndPointX",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillLinearGradientEndPointY",0);Konva.Factory.addComponentsGetterSetter(Konva.Shape,"fillRadialGradientStartPoint",["x","y"]);Konva.Factory.addGetterSetter(Konva.Shape,"fillRadialGradientStartPointX",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillRadialGradientStartPointY",0);Konva.Factory.addComponentsGetterSetter(Konva.Shape,"fillRadialGradientEndPoint",["x","y"]);Konva.Factory.addGetterSetter(Konva.Shape,"fillRadialGradientEndPointX",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillRadialGradientEndPointY",0);Konva.Factory.addGetterSetter(Konva.Shape,"fillPatternRotation",0);Konva.Factory.backCompat(Konva.Shape,{dashArray:"dash",getDashArray:"getDash",setDashArray:"getDash",drawFunc:"sceneFunc",getDrawFunc:"getSceneFunc",setDrawFunc:"setSceneFunc",drawHitFunc:"hitFunc",getDrawHitFunc:"getHitFunc",setDrawHitFunc:"setHitFunc"});Konva.Collection.mapMethods(Konva.Shape)})(Konva);(function(){"use strict";var STAGE="Stage",STRING="string",PX="px",MOUSEOUT="mouseout",MOUSELEAVE="mouseleave",MOUSEOVER="mouseover",MOUSEENTER="mouseenter",MOUSEMOVE="mousemove",MOUSEDOWN="mousedown",MOUSEUP="mouseup",CLICK="click",DBL_CLICK="dblclick",TOUCHSTART="touchstart",TOUCHEND="touchend",TAP="tap",DBL_TAP="dbltap",TOUCHMOVE="touchmove",DOMMOUSESCROLL="DOMMouseScroll",MOUSEWHEEL="mousewheel",WHEEL="wheel",CONTENT_MOUSEOUT="contentMouseout",CONTENT_MOUSEOVER="contentMouseover",CONTENT_MOUSEMOVE="contentMousemove",CONTENT_MOUSEDOWN="contentMousedown",CONTENT_MOUSEUP="contentMouseup",CONTENT_CLICK="contentClick",CONTENT_DBL_CLICK="contentDblclick",CONTENT_TOUCHSTART="contentTouchstart",CONTENT_TOUCHEND="contentTouchend",CONTENT_DBL_TAP="contentDbltap",CONTENT_TAP="contentTap",CONTENT_TOUCHMOVE="contentTouchmove",CONTENT_WHEEL="contentWheel",DIV="div",RELATIVE="relative",KONVA_CONTENT="konvajs-content",SPACE=" ",UNDERSCORE="_",CONTAINER="container",EMPTY_STRING="",EVENTS=[MOUSEDOWN,MOUSEMOVE,MOUSEUP,MOUSEOUT,TOUCHSTART,TOUCHMOVE,TOUCHEND,MOUSEOVER,DOMMOUSESCROLL,MOUSEWHEEL,WHEEL],eventsLength=EVENTS.length;function addEvent(ctx,eventName){ctx.content.addEventListener(eventName,function(evt){ctx[UNDERSCORE+eventName](evt)},false)}Konva.Stage=function(config){this.___init(config)};Konva.Util.addMethods(Konva.Stage,{___init:function(config){this.nodeType=STAGE;Konva.Container.call(this,config);this._id=Konva.idCounter++;this._buildDOM();this._bindContentEvents();this._enableNestedTransforms=false;Konva.stages.push(this)},_validateAdd:function(child){if(child.getType()!=="Layer"){Konva.Util.throw("You may only add layers to the stage.")}},setContainer:function(container){if(typeof container===STRING){if(container.charAt(0)==="."){var className=container.slice(1);container=Konva.document.getElementsByClassName(className)[0]}else{var id;if(container.charAt(0)!=="#"){id=container}else{id=container.slice(1)}container=Konva.document.getElementById(id)}if(!container){throw"Can not find container in document with id "+id}}this._setAttr(CONTAINER,container);return this},shouldDrawHit:function(){return true},draw:function(){Konva.Node.prototype.draw.call(this);return this},setHeight:function(height){Konva.Node.prototype.setHeight.call(this,height);this._resizeDOM();return this},setWidth:function(width){Konva.Node.prototype.setWidth.call(this,width);this._resizeDOM();return this},clear:function(){var layers=this.children,len=layers.length,n;for(n=0;n<len;n++){layers[n].clear()}return this},clone:function(obj){if(!obj){obj={}}obj.container=Konva.document.createElement(DIV);return Konva.Container.prototype.clone.call(this,obj)},destroy:function(){var content=this.content;Konva.Container.prototype.destroy.call(this);if(content&&Konva.Util._isInDocument(content)){this.getContainer().removeChild(content)}var index=Konva.stages.indexOf(this);if(index>-1){Konva.stages.splice(index,1)}return this},getPointerPosition:function(){return this.pointerPos},getStage:function(){return this},getContent:function(){return this.content},toDataURL:function(config){config=config||{};var mimeType=config.mimeType||null,quality=config.quality||null,x=config.x||0,y=config.y||0,canvas=new Konva.SceneCanvas({width:config.width||this.getWidth(),height:config.height||this.getHeight(),pixelRatio:config.pixelRatio}),_context=canvas.getContext()._context,layers=this.children;if(x||y){_context.translate(-1*x,-1*y)}layers.each(function(layer){var width=layer.getCanvas().getWidth();var height=layer.getCanvas().getHeight();var ratio=layer.getCanvas().getPixelRatio();_context.drawImage(layer.getCanvas()._canvas,0,0,width/ratio,height/ratio)});var src=canvas.toDataURL(mimeType,quality);if(config.callback){config.callback(src)}return src},toImage:function(config){var cb=config.callback;config.callback=function(dataUrl){Konva.Util._getImage(dataUrl,function(img){cb(img)})};this.toDataURL(config)},getIntersection:function(pos,selector){var layers=this.getChildren(),len=layers.length,end=len-1,n,shape;for(n=end;n>=0;n--){shape=layers[n].getIntersection(pos,selector);if(shape){return shape}}return null},_resizeDOM:function(){if(this.content){var width=this.getWidth(),height=this.getHeight(),layers=this.getChildren(),len=layers.length,n,layer;this.content.style.width=width+PX;this.content.style.height=height+PX;this.bufferCanvas.setSize(width,height);this.bufferHitCanvas.setSize(width,height);for(n=0;n<len;n++){layer=layers[n];layer.setSize(width,height);layer.draw()}}},add:function(layer){if(arguments.length>1){for(var i=0;i<arguments.length;i++){this.add(arguments[i])}return this}Konva.Container.prototype.add.call(this,layer);layer._setCanvasSize(this.width(),this.height());layer.draw();this.content.appendChild(layer.canvas._canvas);return this},getParent:function(){return null},getLayer:function(){return null},getLayers:function(){return this.getChildren()},_bindContentEvents:function(){for(var n=0;n<eventsLength;n++){addEvent(this,EVENTS[n])}},_mouseover:function(evt){if(!Konva.UA.mobile){this._setPointerPosition(evt);this._fire(CONTENT_MOUSEOVER,{evt:evt})}},_mouseout:function(evt){if(!Konva.UA.mobile){this._setPointerPosition(evt);var targetShape=this.targetShape;if(targetShape&&!Konva.isDragging()){targetShape._fireAndBubble(MOUSEOUT,{evt:evt});targetShape._fireAndBubble(MOUSELEAVE,{evt:evt});this.targetShape=null}this.pointerPos=undefined;this._fire(CONTENT_MOUSEOUT,{evt:evt})}},_mousemove:function(evt){if(Konva.UA.ieMobile){return this._touchmove(evt)}if((typeof evt.movementX!=="undefined"||typeof evt.movementY!=="undefined")&&evt.movementY===0&&evt.movementX===0){return null}if(Konva.UA.mobile){return null}this._setPointerPosition(evt);var dd=Konva.DD,shape;if(!Konva.isDragging()){shape=this.getIntersection(this.getPointerPosition());if(shape&&shape.isListening()){if(!Konva.isDragging()&&(!this.targetShape||this.targetShape._id!==shape._id)){if(this.targetShape){this.targetShape._fireAndBubble(MOUSEOUT,{evt:evt},shape);this.targetShape._fireAndBubble(MOUSELEAVE,{evt:evt},shape)}shape._fireAndBubble(MOUSEOVER,{evt:evt},this.targetShape);shape._fireAndBubble(MOUSEENTER,{evt:evt},this.targetShape);this.targetShape=shape}else{shape._fireAndBubble(MOUSEMOVE,{evt:evt})}}else{if(this.targetShape&&!Konva.isDragging()){this.targetShape._fireAndBubble(MOUSEOUT,{evt:evt});this.targetShape._fireAndBubble(MOUSELEAVE,{evt:evt});this.targetShape=null}}this._fire(CONTENT_MOUSEMOVE,{evt:evt})}if(dd){dd._drag(evt)}if(evt.preventDefault){evt.preventDefault()}},_mousedown:function(evt){if(Konva.UA.ieMobile){return this._touchstart(evt)}if(!Konva.UA.mobile){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition());Konva.listenClickTap=true;if(shape&&shape.isListening()){this.clickStartShape=shape;shape._fireAndBubble(MOUSEDOWN,{evt:evt})}this._fire(CONTENT_MOUSEDOWN,{evt:evt})}if(evt.preventDefault){evt.preventDefault()}},_mouseup:function(evt){if(Konva.UA.ieMobile){return this._touchend(evt)}if(!Konva.UA.mobile){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition()),clickStartShape=this.clickStartShape,fireDblClick=false,dd=Konva.DD;if(Konva.inDblClickWindow){fireDblClick=true;Konva.inDblClickWindow=false}else if(!dd||!dd.justDragged){Konva.inDblClickWindow=true}else if(dd){dd.justDragged=false}setTimeout(function(){Konva.inDblClickWindow=false},Konva.dblClickWindow);if(shape&&shape.isListening()){shape._fireAndBubble(MOUSEUP,{evt:evt});if(Konva.listenClickTap&&clickStartShape&&clickStartShape._id===shape._id){shape._fireAndBubble(CLICK,{evt:evt});if(fireDblClick){shape._fireAndBubble(DBL_CLICK,{evt:evt})}}}this._fire(CONTENT_MOUSEUP,{evt:evt});if(Konva.listenClickTap){this._fire(CONTENT_CLICK,{evt:evt});if(fireDblClick){this._fire(CONTENT_DBL_CLICK,{evt:evt})}}Konva.listenClickTap=false}if(evt.preventDefault){evt.preventDefault()}},_touchstart:function(evt){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition());Konva.listenClickTap=true;if(shape&&shape.isListening()){this.tapStartShape=shape;shape._fireAndBubble(TOUCHSTART,{evt:evt});if(shape.isListening()&&evt.preventDefault){evt.preventDefault()}}this._fire(CONTENT_TOUCHSTART,{evt:evt})},_touchend:function(evt){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition()),fireDblClick=false;if(Konva.inDblClickWindow){fireDblClick=true;Konva.inDblClickWindow=false}else{Konva.inDblClickWindow=true}setTimeout(function(){Konva.inDblClickWindow=false},Konva.dblClickWindow);if(shape&&shape.isListening()){shape._fireAndBubble(TOUCHEND,{evt:evt});if(Konva.listenClickTap&&shape._id===this.tapStartShape._id){shape._fireAndBubble(TAP,{evt:evt});if(fireDblClick){shape._fireAndBubble(DBL_TAP,{evt:evt})}}if(shape.isListening()&&evt.preventDefault){evt.preventDefault()}}this._fire(CONTENT_TOUCHEND,{evt:evt});if(Konva.listenClickTap){this._fire(CONTENT_TAP,{evt:evt});if(fireDblClick){this._fire(CONTENT_DBL_TAP,{evt:evt})}}Konva.listenClickTap=false},_touchmove:function(evt){this._setPointerPosition(evt);var dd=Konva.DD,shape;if(!Konva.isDragging()){shape=this.getIntersection(this.getPointerPosition());if(shape&&shape.isListening()){shape._fireAndBubble(TOUCHMOVE,{evt:evt});if(shape.isListening()&&evt.preventDefault){evt.preventDefault()}}this._fire(CONTENT_TOUCHMOVE,{evt:evt})}if(dd){dd._drag(evt);if(Konva.isDragging()){evt.preventDefault()}}},_DOMMouseScroll:function(evt){this._mousewheel(evt)},_mousewheel:function(evt){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition());if(shape&&shape.isListening()){shape._fireAndBubble(WHEEL,{evt:evt})}this._fire(CONTENT_WHEEL,{evt:evt})},_wheel:function(evt){this._mousewheel(evt)},_setPointerPosition:function(evt){var contentPosition=this._getContentPosition(),x=null,y=null;evt=evt?evt:window.event;if(evt.touches!==undefined){if(evt.touches.length>0){var touch=evt.touches[0];x=touch.clientX-contentPosition.left;y=touch.clientY-contentPosition.top}}else{x=evt.clientX-contentPosition.left;y=evt.clientY-contentPosition.top}if(x!==null&&y!==null){this.pointerPos={x:x,y:y}}},_getContentPosition:function(){var rect=this.content.getBoundingClientRect?this.content.getBoundingClientRect():{top:0,left:0};return{top:rect.top,left:rect.left}},_buildDOM:function(){var container=this.getContainer();if(!container){if(Konva.Util.isBrowser()){throw"Stage has no container. A container is required."}else{container=Konva.document.createElement(DIV)}}container.innerHTML=EMPTY_STRING;this.content=Konva.document.createElement(DIV);this.content.style.position=RELATIVE;this.content.className=KONVA_CONTENT;this.content.setAttribute("role","presentation");container.appendChild(this.content);this.bufferCanvas=new Konva.SceneCanvas;this.bufferHitCanvas=new Konva.HitCanvas({pixelRatio:1});this._resizeDOM()},_onContent:function(typesStr,handler){var types=typesStr.split(SPACE),len=types.length,n,baseEvent;for(n=0;n<len;n++){baseEvent=types[n];this.content.addEventListener(baseEvent,handler,false)}},cache:function(){Konva.Util.warn("Cache function is not allowed for stage. You may use cache only for layers, groups and shapes.")},clearCache:function(){}});Konva.Util.extend(Konva.Stage,Konva.Container);Konva.Factory.addGetter(Konva.Stage,"container");Konva.Factory.addOverloadedGetterSetter(Konva.Stage,"container")})();(function(){"use strict";Konva.BaseLayer=function(config){this.___init(config)};Konva.Util.addMethods(Konva.BaseLayer,{___init:function(config){this.nodeType="Layer";Konva.Container.call(this,config)},createPNGStream:function(){return this.canvas._canvas.createPNGStream()},getCanvas:function(){return this.canvas},getHitCanvas:function(){return this.hitCanvas},getContext:function(){return this.getCanvas().getContext()},clear:function(bounds){this.getContext().clear(bounds);return this},clearHitCache:function(){this._hitImageData=undefined},setZIndex:function(index){Konva.Node.prototype.setZIndex.call(this,index);var stage=this.getStage();if(stage){stage.content.removeChild(this.getCanvas()._canvas);if(index<stage.getChildren().length-1){stage.content.insertBefore(this.getCanvas()._canvas,stage.getChildren()[index+1].getCanvas()._canvas)}else{stage.content.appendChild(this.getCanvas()._canvas)}}return this},moveToTop:function(){Konva.Node.prototype.moveToTop.call(this);var stage=this.getStage();if(stage){stage.content.removeChild(this.getCanvas()._canvas);stage.content.appendChild(this.getCanvas()._canvas)}return this},moveUp:function(){var moved=Konva.Node.prototype.moveUp.call(this);if(!moved){return this}var stage=this.getStage();if(!stage){return this}stage.content.removeChild(this.getCanvas()._canvas);if(this.index<stage.getChildren().length-1){stage.content.insertBefore(this.getCanvas()._canvas,stage.getChildren()[this.index+1].getCanvas()._canvas)}else{stage.content.appendChild(this.getCanvas()._canvas)}return this},moveDown:function(){if(Konva.Node.prototype.moveDown.call(this)){var stage=this.getStage();if(stage){var children=stage.getChildren();stage.content.removeChild(this.getCanvas()._canvas);stage.content.insertBefore(this.getCanvas()._canvas,children[this.index+1].getCanvas()._canvas)}}return this},moveToBottom:function(){if(Konva.Node.prototype.moveToBottom.call(this)){var stage=this.getStage();if(stage){var children=stage.getChildren();stage.content.removeChild(this.getCanvas()._canvas);stage.content.insertBefore(this.getCanvas()._canvas,children[1].getCanvas()._canvas)}}return this},getLayer:function(){return this},remove:function(){var _canvas=this.getCanvas()._canvas;Konva.Node.prototype.remove.call(this);if(_canvas&&_canvas.parentNode&&Konva.Util._isInDocument(_canvas)){_canvas.parentNode.removeChild(_canvas)}return this},getStage:function(){return this.parent},setSize:function(width,height){this.canvas.setSize(width,height);return this},getWidth:function(){if(this.parent){return this.parent.getWidth()}},setWidth:function(){Konva.Util.warn('Can not change width of layer. Use "stage.width(value)" function instead.')},getHeight:function(){if(this.parent){return this.parent.getHeight()}},setHeight:function(){Konva.Util.warn('Can not change height of layer. Use "stage.height(value)" function instead.')},_applyTransform:function(shape,context,top){var m=shape.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5])}});Konva.Util.extend(Konva.BaseLayer,Konva.Container);Konva.Factory.addGetterSetter(Konva.BaseLayer,"clearBeforeDraw",true);Konva.Collection.mapMethods(Konva.BaseLayer)})();(function(){"use strict";var HASH="#",BEFORE_DRAW="beforeDraw",DRAW="draw",INTERSECTION_OFFSETS=[{x:0,y:0},{x:-1,y:0},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:1}],INTERSECTION_OFFSETS_LEN=INTERSECTION_OFFSETS.length;Konva.Layer=function(config){this.____init(config)};Konva.Util.addMethods(Konva.Layer,{____init:function(config){this.nodeType="Layer";this.canvas=new Konva.SceneCanvas;this.hitCanvas=new Konva.HitCanvas({pixelRatio:1});Konva.BaseLayer.call(this,config)},_setCanvasSize:function(width,height){this.canvas.setSize(width,height);this.hitCanvas.setSize(width,height)},_validateAdd:function(child){var type=child.getType();if(type!=="Group"&&type!=="Shape"){Konva.Util.throw("You may only add groups and shapes to a layer.")}},getIntersection:function(pos,selector){var obj,i,intersectionOffset,shape;if(!this.hitGraphEnabled()||!this.isVisible()){return null}var spiralSearchDistance=1;var continueSearch=false;while(true){for(i=0;i<INTERSECTION_OFFSETS_LEN;i++){intersectionOffset=INTERSECTION_OFFSETS[i];obj=this._getIntersection({x:pos.x+intersectionOffset.x*spiralSearchDistance,y:pos.y+intersectionOffset.y*spiralSearchDistance});shape=obj.shape;if(shape&&selector){return shape.findAncestor(selector,true)}else if(shape){return shape}continueSearch=!!obj.antialiased;if(!obj.antialiased){break}}if(continueSearch){spiralSearchDistance+=1}else{return null}}},_getImageData:function(x,y){var width=this.hitCanvas.width||1,height=this.hitCanvas.height||1,index=Math.round(y)*width+Math.round(x);if(!this._hitImageData){this._hitImageData=this.hitCanvas.context.getImageData(0,0,width,height)}return[this._hitImageData.data[4*index+0],this._hitImageData.data[4*index+1],this._hitImageData.data[4*index+2],this._hitImageData.data[4*index+3]]},_getIntersection:function(pos){var ratio=this.hitCanvas.pixelRatio;var p=this.hitCanvas.context.getImageData(Math.round(pos.x*ratio),Math.round(pos.y*ratio),1,1).data,p3=p[3],colorKey,shape;if(p3===255){colorKey=Konva.Util._rgbToHex(p[0],p[1],p[2]);shape=Konva.shapes[HASH+colorKey];if(shape){return{shape:shape}}return{antialiased:true}}else if(p3>0){return{antialiased:true}}return{}},drawScene:function(can,top){var layer=this.getLayer(),canvas=can||layer&&layer.getCanvas();this._fire(BEFORE_DRAW,{node:this});if(this.getClearBeforeDraw()){canvas.getContext().clear()}Konva.Container.prototype.drawScene.call(this,canvas,top);this._fire(DRAW,{node:this});return this},drawHit:function(can,top){var layer=this.getLayer(),canvas=can||layer&&layer.hitCanvas;if(layer&&layer.getClearBeforeDraw()){layer.getHitCanvas().getContext().clear()}Konva.Container.prototype.drawHit.call(this,canvas,top);this.imageData=null;return this},clear:function(bounds){Konva.BaseLayer.prototype.clear.call(this,bounds);this.getHitCanvas().getContext().clear(bounds);this.imageData=null;return this},setVisible:function(visible){Konva.Node.prototype.setVisible.call(this,visible);if(visible){this.getCanvas()._canvas.style.display="block";this.hitCanvas._canvas.style.display="block"}else{this.getCanvas()._canvas.style.display="none";this.hitCanvas._canvas.style.display="none"}return this},enableHitGraph:function(){this.setHitGraphEnabled(true);return this},disableHitGraph:function(){this.setHitGraphEnabled(false);return this},setSize:function(width,height){Konva.BaseLayer.prototype.setSize.call(this,width,height);this.hitCanvas.setSize(width,height);return this}});Konva.Util.extend(Konva.Layer,Konva.BaseLayer);Konva.Factory.addGetterSetter(Konva.Layer,"hitGraphEnabled",true);Konva.Collection.mapMethods(Konva.Layer)})();(function(){"use strict";Konva.FastLayer=function(config){this.____init(config)};Konva.Util.addMethods(Konva.FastLayer,{____init:function(config){this.nodeType="Layer";this.canvas=new Konva.SceneCanvas;Konva.BaseLayer.call(this,config)},_validateAdd:function(child){var type=child.getType();if(type!=="Shape"){Konva.Util.throw("You may only add shapes to a fast layer.")}},_setCanvasSize:function(width,height){this.canvas.setSize(width,height)},hitGraphEnabled:function(){return false},getIntersection:function(){return null},drawScene:function(can){var layer=this.getLayer(),canvas=can||layer&&layer.getCanvas();if(this.getClearBeforeDraw()){canvas.getContext().clear()}Konva.Container.prototype.drawScene.call(this,canvas);return this},draw:function(){this.drawScene();return this},setVisible:function(visible){Konva.Node.prototype.setVisible.call(this,visible);if(visible){this.getCanvas()._canvas.style.display="block"}else{this.getCanvas()._canvas.style.display="none"}return this}});Konva.Util.extend(Konva.FastLayer,Konva.BaseLayer);Konva.Collection.mapMethods(Konva.FastLayer)})();(function(){"use strict";Konva.Group=function(config){this.___init(config)};Konva.Util.addMethods(Konva.Group,{___init:function(config){this.nodeType="Group";Konva.Container.call(this,config)},_validateAdd:function(child){var type=child.getType();if(type!=="Group"&&type!=="Shape"){Konva.Util.throw("You may only add groups and shapes to groups.")}}});Konva.Util.extend(Konva.Group,Konva.Container);Konva.Collection.mapMethods(Konva.Group)})();(function(Konva){"use strict";var now=function(){if(Konva.global.performance&&Konva.global.performance.now){return function(){return Konva.global.performance.now()}}return function(){return(new Date).getTime()}}();function FRAF(callback){setTimeout(callback,1e3/60)}var RAF=function(){return Konva.global.requestAnimationFrame||Konva.global.webkitRequestAnimationFrame||Konva.global.mozRequestAnimationFrame||Konva.global.oRequestAnimationFrame||Konva.global.msRequestAnimationFrame||FRAF}();function requestAnimFrame(){return RAF.apply(Konva.global,arguments)}Konva.Animation=function(func,layers){var Anim=Konva.Animation;this.func=func;this.setLayers(layers);this.id=Anim.animIdCounter++;this.frame={time:0,timeDiff:0,lastTime:now()}};Konva.Animation.prototype={setLayers:function(layers){var lays=[];if(!layers){lays=[]}else if(layers.length>0){lays=layers}else{lays=[layers]}this.layers=lays;return this},getLayers:function(){return this.layers},addLayer:function(layer){var layers=this.layers,len=layers.length,n;for(n=0;n<len;n++){if(layers[n]._id===layer._id){return false}}this.layers.push(layer);return true},isRunning:function(){var a=Konva.Animation,animations=a.animations,len=animations.length,n;for(n=0;n<len;n++){if(animations[n].id===this.id){return true}}return false},start:function(){var Anim=Konva.Animation;this.stop();this.frame.timeDiff=0;this.frame.lastTime=now();Anim._addAnimation(this);return this},stop:function(){Konva.Animation._removeAnimation(this);return this},_updateFrameObject:function(time){this.frame.timeDiff=time-this.frame.lastTime;this.frame.lastTime=time;this.frame.time+=this.frame.timeDiff;this.frame.frameRate=1e3/this.frame.timeDiff}};Konva.Animation.animations=[];Konva.Animation.animIdCounter=0;Konva.Animation.animRunning=false;Konva.Animation._addAnimation=function(anim){this.animations.push(anim);this._handleAnimation()};Konva.Animation._removeAnimation=function(anim){var id=anim.id,animations=this.animations,len=animations.length,n;for(n=0;n<len;n++){if(animations[n].id===id){this.animations.splice(n,1);break}}};Konva.Animation._runFrames=function(){var layerHash={},animations=this.animations,anim,layers,func,n,i,layersLen,layer,key,needRedraw;for(n=0;n<animations.length;n++){anim=animations[n];layers=anim.layers;func=anim.func;anim._updateFrameObject(now());layersLen=layers.length;if(func){needRedraw=func.call(anim,anim.frame)!==false}else{needRedraw=true}if(!needRedraw){continue}for(i=0;i<layersLen;i++){layer=layers[i];if(layer._id!==undefined){layerHash[layer._id]=layer}}}for(key in layerHash){if(!layerHash.hasOwnProperty(key)){continue}layerHash[key].draw()}};Konva.Animation._animationLoop=function(){var Anim=Konva.Animation;if(Anim.animations.length){Anim._runFrames();requestAnimFrame(Anim._animationLoop)}else{Anim.animRunning=false}};Konva.Animation._handleAnimation=function(){if(!this.animRunning){this.animRunning=true;requestAnimFrame(this._animationLoop)}};Konva.BaseLayer.prototype.batchDraw=function(){var that=this,Anim=Konva.Animation;if(!this.batchAnim){this.batchAnim=new Anim(function(){that.batchAnim.stop()},this)}this.lastBatchDrawTime=now();if(!this.batchAnim.isRunning()){this.batchAnim.start()}return this};Konva.Stage.prototype.batchDraw=function(){this.getChildren().each(function(layer){layer.batchDraw()});return this}})(Konva);(function(){"use strict";var blacklist={node:1,duration:1,easing:1,onFinish:1,yoyo:1},PAUSED=1,PLAYING=2,REVERSING=3,idCounter=0,colorAttrs=["fill","stroke","shadowColor"];var Tween=function(prop,propFunc,func,begin,finish,duration,yoyo){this.prop=prop;this.propFunc=propFunc;this.begin=begin;this._pos=begin;this.duration=duration;this._change=0;this.prevPos=0;this.yoyo=yoyo;this._time=0;this._position=0;this._startTime=0;this._finish=0;this.func=func;this._change=finish-this.begin;this.pause()};Tween.prototype={fire:function(str){var handler=this[str];if(handler){handler()}},setTime:function(t){if(t>this.duration){if(this.yoyo){this._time=this.duration;this.reverse()}else{this.finish()}}else if(t<0){if(this.yoyo){this._time=0;this.play()}else{this.reset()}}else{this._time=t;this.update()}},getTime:function(){return this._time},setPosition:function(p){this.prevPos=this._pos;this.propFunc(p);this._pos=p},getPosition:function(t){if(t===undefined){t=this._time}return this.func(t,this.begin,this._change,this.duration)},play:function(){this.state=PLAYING;this._startTime=this.getTimer()-this._time;this.onEnterFrame();this.fire("onPlay")},reverse:function(){this.state=REVERSING;this._time=this.duration-this._time;this._startTime=this.getTimer()-this._time;this.onEnterFrame();this.fire("onReverse")},seek:function(t){this.pause();this._time=t;this.update();this.fire("onSeek")},reset:function(){this.pause();this._time=0;this.update();this.fire("onReset")},finish:function(){this.pause();this._time=this.duration;this.update();this.fire("onFinish")},update:function(){this.setPosition(this.getPosition(this._time))},onEnterFrame:function(){var t=this.getTimer()-this._startTime;if(this.state===PLAYING){this.setTime(t)}else if(this.state===REVERSING){this.setTime(this.duration-t)}},pause:function(){this.state=PAUSED;this.fire("onPause")},getTimer:function(){return(new Date).getTime()}};Konva.Tween=function(config){var that=this,node=config.node,nodeId=node._id,duration,easing=config.easing||Konva.Easings.Linear,yoyo=!!config.yoyo,key;if(typeof config.duration==="undefined"){duration=1}else if(config.duration===0){duration=.001}else{duration=config.duration}this.node=node;this._id=idCounter++;var layers=node.getLayer()||(node instanceof Konva.Stage?node.getLayers():null);if(!layers){Konva.Util.error("Tween constructor have `node` that is not in a layer. Please add node into layer first.")}this.anim=new Konva.Animation(function(){that.tween.onEnterFrame()},layers);this.tween=new Tween(key,function(i){that._tweenFunc(i)},easing,0,1,duration*1e3,yoyo);this._addListeners();if(!Konva.Tween.attrs[nodeId]){Konva.Tween.attrs[nodeId]={}}if(!Konva.Tween.attrs[nodeId][this._id]){Konva.Tween.attrs[nodeId][this._id]={}}if(!Konva.Tween.tweens[nodeId]){Konva.Tween.tweens[nodeId]={}}for(key in config){if(blacklist[key]===undefined){this._addAttr(key,config[key])}}this.reset();this.onFinish=config.onFinish;this.onReset=config.onReset};Konva.Tween.attrs={};Konva.Tween.tweens={};Konva.Tween.prototype={_addAttr:function(key,end){var node=this.node,nodeId=node._id,start,diff,tweenId,n,len,trueEnd,trueStart;tweenId=Konva.Tween.tweens[nodeId][key];if(tweenId){delete Konva.Tween.attrs[nodeId][tweenId][key]}start=node.getAttr(key);if(Konva.Util._isArray(end)){diff=[];len=Math.max(end.length,start.length);if(key==="points"&&end.length!==start.length){if(end.length>start.length){trueStart=start;start=Konva.Util._prepareArrayForTween(start,end,node.closed())}else{trueEnd=end;end=Konva.Util._prepareArrayForTween(end,start,node.closed())}}for(n=0;n<len;n++){diff.push(end[n]-start[n])}}else if(colorAttrs.indexOf(key)!==-1){start=Konva.Util.colorToRGBA(start);var endRGBA=Konva.Util.colorToRGBA(end);diff={r:endRGBA.r-start.r,g:endRGBA.g-start.g,b:endRGBA.b-start.b,a:endRGBA.a-start.a}}else{diff=end-start}Konva.Tween.attrs[nodeId][this._id][key]={start:start,diff:diff,end:end,trueEnd:trueEnd,trueStart:trueStart};Konva.Tween.tweens[nodeId][key]=this._id},_tweenFunc:function(i){var node=this.node,attrs=Konva.Tween.attrs[node._id][this._id],key,attr,start,diff,newVal,n,len,end;for(key in attrs){attr=attrs[key];start=attr.start;diff=attr.diff;end=attr.end;if(Konva.Util._isArray(start)){newVal=[];len=Math.max(start.length,end.length);for(n=0;n<len;n++){newVal.push((start[n]||0)+diff[n]*i)}}else if(colorAttrs.indexOf(key)!==-1){newVal="rgba("+Math.round(start.r+diff.r*i)+","+Math.round(start.g+diff.g*i)+","+Math.round(start.b+diff.b*i)+","+(start.a+diff.a*i)+")"}else{newVal=start+diff*i}node.setAttr(key,newVal)}},_addListeners:function(){var that=this;this.tween.onPlay=function(){that.anim.start()};this.tween.onReverse=function(){that.anim.start()};this.tween.onPause=function(){that.anim.stop()};this.tween.onFinish=function(){var node=that.node;var attrs=Konva.Tween.attrs[node._id][that._id];if(attrs.points&&attrs.points.trueEnd){node.points(attrs.points.trueEnd)}if(that.onFinish){that.onFinish.call(that)}};this.tween.onReset=function(){var node=that.node;var attrs=Konva.Tween.attrs[node._id][that._id];if(attrs.points&&attrs.points.trueStart){node.points(attrs.points.trueStart)}if(that.onReset){that.onReset()}}},play:function(){this.tween.play();return this},reverse:function(){this.tween.reverse();return this},reset:function(){this.tween.reset();return this},seek:function(t){
this.tween.seek(t*1e3);return this},pause:function(){this.tween.pause();return this},finish:function(){this.tween.finish();return this},destroy:function(){var nodeId=this.node._id,thisId=this._id,attrs=Konva.Tween.tweens[nodeId],key;this.pause();for(key in attrs){delete Konva.Tween.tweens[nodeId][key]}delete Konva.Tween.attrs[nodeId][thisId]}};Konva.Node.prototype.to=function(params){var onFinish=params.onFinish;params.node=this;params.onFinish=function(){this.destroy();if(onFinish){onFinish()}};var tween=new Konva.Tween(params);tween.play()};Konva.Easings={BackEaseIn:function(t,b,c,d){var s=1.70158;return c*(t/=d)*t*((s+1)*t-s)+b},BackEaseOut:function(t,b,c,d){var s=1.70158;return c*((t=t/d-1)*t*((s+1)*t+s)+1)+b},BackEaseInOut:function(t,b,c,d){var s=1.70158;if((t/=d/2)<1){return c/2*(t*t*(((s*=1.525)+1)*t-s))+b}return c/2*((t-=2)*t*(((s*=1.525)+1)*t+s)+2)+b},ElasticEaseIn:function(t,b,c,d,a,p){var s=0;if(t===0){return b}if((t/=d)===1){return b+c}if(!p){p=d*.3}if(!a||a<Math.abs(c)){a=c;s=p/4}else{s=p/(2*Math.PI)*Math.asin(c/a)}return-(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p))+b},ElasticEaseOut:function(t,b,c,d,a,p){var s=0;if(t===0){return b}if((t/=d)===1){return b+c}if(!p){p=d*.3}if(!a||a<Math.abs(c)){a=c;s=p/4}else{s=p/(2*Math.PI)*Math.asin(c/a)}return a*Math.pow(2,-10*t)*Math.sin((t*d-s)*(2*Math.PI)/p)+c+b},ElasticEaseInOut:function(t,b,c,d,a,p){var s=0;if(t===0){return b}if((t/=d/2)===2){return b+c}if(!p){p=d*(.3*1.5)}if(!a||a<Math.abs(c)){a=c;s=p/4}else{s=p/(2*Math.PI)*Math.asin(c/a)}if(t<1){return-.5*(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p))+b}return a*Math.pow(2,-10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p)*.5+c+b},BounceEaseOut:function(t,b,c,d){if((t/=d)<1/2.75){return c*(7.5625*t*t)+b}else if(t<2/2.75){return c*(7.5625*(t-=1.5/2.75)*t+.75)+b}else if(t<2.5/2.75){return c*(7.5625*(t-=2.25/2.75)*t+.9375)+b}else{return c*(7.5625*(t-=2.625/2.75)*t+.984375)+b}},BounceEaseIn:function(t,b,c,d){return c-Konva.Easings.BounceEaseOut(d-t,0,c,d)+b},BounceEaseInOut:function(t,b,c,d){if(t<d/2){return Konva.Easings.BounceEaseIn(t*2,0,c,d)*.5+b}else{return Konva.Easings.BounceEaseOut(t*2-d,0,c,d)*.5+c*.5+b}},EaseIn:function(t,b,c,d){return c*(t/=d)*t+b},EaseOut:function(t,b,c,d){return-c*(t/=d)*(t-2)+b},EaseInOut:function(t,b,c,d){if((t/=d/2)<1){return c/2*t*t+b}return-c/2*(--t*(t-2)-1)+b},StrongEaseIn:function(t,b,c,d){return c*(t/=d)*t*t*t*t+b},StrongEaseOut:function(t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b},StrongEaseInOut:function(t,b,c,d){if((t/=d/2)<1){return c/2*t*t*t*t*t+b}return c/2*((t-=2)*t*t*t*t+2)+b},Linear:function(t,b,c,d){return c*t/d+b}}})();(function(){"use strict";Konva.DD={anim:new Konva.Animation(function(){var b=this.dirty;this.dirty=false;return b}),isDragging:false,justDragged:false,offset:{x:0,y:0},node:null,_drag:function(evt){var dd=Konva.DD,node=dd.node;if(node){if(!dd.isDragging){var pos=node.getStage().getPointerPosition();var dragDistance=node.dragDistance();var distance=Math.max(Math.abs(pos.x-dd.startPointerPos.x),Math.abs(pos.y-dd.startPointerPos.y));if(distance<dragDistance){return}}node.getStage()._setPointerPosition(evt);node._setDragPosition(evt);if(!dd.isDragging){dd.isDragging=true;node.fire("dragstart",{type:"dragstart",target:node,evt:evt},true)}node.fire("dragmove",{type:"dragmove",target:node,evt:evt},true)}},_endDragBefore:function(evt){var dd=Konva.DD,node=dd.node,layer;if(node){layer=node.getLayer();dd.anim.stop();if(dd.isDragging){dd.isDragging=false;dd.justDragged=true;Konva.listenClickTap=false;if(evt){evt.dragEndNode=node}}delete dd.node;(layer||node).draw()}},_endDragAfter:function(evt){evt=evt||{};var dragEndNode=evt.dragEndNode;if(evt&&dragEndNode){dragEndNode.fire("dragend",{type:"dragend",target:dragEndNode,evt:evt},true)}}};Konva.Node.prototype.startDrag=function(){var dd=Konva.DD,stage=this.getStage(),layer=this.getLayer(),pos=stage.getPointerPosition(),ap=this.getAbsolutePosition();if(pos){if(dd.node){dd.node.stopDrag()}dd.node=this;dd.startPointerPos=pos;dd.offset.x=pos.x-ap.x;dd.offset.y=pos.y-ap.y;dd.anim.setLayers(layer||this.getLayers());dd.anim.start();this._setDragPosition()}};Konva.Node.prototype._setDragPosition=function(evt){var dd=Konva.DD,pos=this.getStage().getPointerPosition(),dbf=this.getDragBoundFunc();if(!pos){return}var newNodePos={x:pos.x-dd.offset.x,y:pos.y-dd.offset.y};if(dbf!==undefined){newNodePos=dbf.call(this,newNodePos,evt)}this.setAbsolutePosition(newNodePos);if(!this._lastPos||this._lastPos.x!==newNodePos.x||this._lastPos.y!==newNodePos.y){dd.anim.dirty=true}this._lastPos=newNodePos};Konva.Node.prototype.stopDrag=function(){var dd=Konva.DD,evt={};dd._endDragBefore(evt);dd._endDragAfter(evt)};Konva.Node.prototype.setDraggable=function(draggable){this._setAttr("draggable",draggable);this._dragChange()};var origDestroy=Konva.Node.prototype.destroy;Konva.Node.prototype.destroy=function(){var dd=Konva.DD;if(dd.node&&dd.node._id===this._id){this.stopDrag()}origDestroy.call(this)};Konva.Node.prototype.isDragging=function(){var dd=Konva.DD;return!!(dd.node&&dd.node._id===this._id&&dd.isDragging)};Konva.Node.prototype._listenDrag=function(){var that=this;this._dragCleanup();if(this.getClassName()==="Stage"){this.on("contentMousedown.konva contentTouchstart.konva",function(evt){if(!Konva.DD.node){that.startDrag(evt)}})}else{this.on("mousedown.konva touchstart.konva",function(evt){if(evt.evt.button===1||evt.evt.button===2){return}if(!Konva.DD.node){that.startDrag(evt)}})}};Konva.Node.prototype._dragChange=function(){if(this.attrs.draggable){this._listenDrag()}else{this._dragCleanup();var stage=this.getStage();var dd=Konva.DD;if(stage&&dd.node&&dd.node._id===this._id){dd.node.stopDrag()}}};Konva.Node.prototype._dragCleanup=function(){if(this.getClassName()==="Stage"){this.off("contentMousedown.konva");this.off("contentTouchstart.konva")}else{this.off("mousedown.konva");this.off("touchstart.konva")}};Konva.Factory.addGetterSetter(Konva.Node,"dragBoundFunc");Konva.Factory.addGetter(Konva.Node,"draggable",false);Konva.Factory.addOverloadedGetterSetter(Konva.Node,"draggable");var html=Konva.document.documentElement;html.addEventListener("mouseup",Konva.DD._endDragBefore,true);html.addEventListener("touchend",Konva.DD._endDragBefore,true);html.addEventListener("mouseup",Konva.DD._endDragAfter,false);html.addEventListener("touchend",Konva.DD._endDragAfter,false)})();(function(){"use strict";Konva.Rect=function(config){this.___init(config)};Konva.Rect.prototype={___init:function(config){Konva.Shape.call(this,config);this.className="Rect";this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var cornerRadius=this.getCornerRadius(),width=this.getWidth(),height=this.getHeight();context.beginPath();if(!cornerRadius){context.rect(0,0,width,height)}else{cornerRadius=Math.min(cornerRadius,width/2,height/2);context.moveTo(cornerRadius,0);context.lineTo(width-cornerRadius,0);context.arc(width-cornerRadius,cornerRadius,cornerRadius,Math.PI*3/2,0,false);context.lineTo(width,height-cornerRadius);context.arc(width-cornerRadius,height-cornerRadius,cornerRadius,0,Math.PI/2,false);context.lineTo(cornerRadius,height);context.arc(cornerRadius,height-cornerRadius,cornerRadius,Math.PI/2,Math.PI,false);context.lineTo(0,cornerRadius);context.arc(cornerRadius,cornerRadius,cornerRadius,Math.PI,Math.PI*3/2,false)}context.closePath();context.fillStrokeShape(this)}};Konva.Util.extend(Konva.Rect,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Rect,"cornerRadius",0);Konva.Collection.mapMethods(Konva.Rect)})();(function(){"use strict";var PIx2=Math.PI*2-1e-4,CIRCLE="Circle";Konva.Circle=function(config){this.___init(config)};Konva.Circle.prototype={_centroid:true,___init:function(config){Konva.Shape.call(this,config);this.className=CIRCLE;this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){context.beginPath();context.arc(0,0,this.getRadius(),0,PIx2,false);context.closePath();context.fillStrokeShape(this)},getWidth:function(){return this.getRadius()*2},getHeight:function(){return this.getRadius()*2},setWidth:function(width){Konva.Node.prototype.setWidth.call(this,width);if(this.radius()!==width/2){this.setRadius(width/2)}},setHeight:function(height){Konva.Node.prototype.setHeight.call(this,height);if(this.radius()!==height/2){this.setRadius(height/2)}}};Konva.Util.extend(Konva.Circle,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Circle,"radius",0);Konva.Factory.addOverloadedGetterSetter(Konva.Circle,"radius");Konva.Collection.mapMethods(Konva.Circle)})();(function(){"use strict";var PIx2=Math.PI*2-1e-4,ELLIPSE="Ellipse";Konva.Ellipse=function(config){this.___init(config)};Konva.Ellipse.prototype={_centroid:true,___init:function(config){Konva.Shape.call(this,config);this.className=ELLIPSE;this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var rx=this.getRadiusX(),ry=this.getRadiusY();context.beginPath();context.save();if(rx!==ry){context.scale(1,ry/rx)}context.arc(0,0,rx,0,PIx2,false);context.restore();context.closePath();context.fillStrokeShape(this)},getWidth:function(){return this.getRadiusX()*2},getHeight:function(){return this.getRadiusY()*2},setWidth:function(width){Konva.Node.prototype.setWidth.call(this,width);this.setRadius({x:width/2})},setHeight:function(height){Konva.Node.prototype.setHeight.call(this,height);this.setRadius({y:height/2})}};Konva.Util.extend(Konva.Ellipse,Konva.Shape);Konva.Factory.addComponentsGetterSetter(Konva.Ellipse,"radius",["x","y"]);Konva.Factory.addGetterSetter(Konva.Ellipse,"radiusX",0);Konva.Factory.addGetterSetter(Konva.Ellipse,"radiusY",0);Konva.Collection.mapMethods(Konva.Ellipse)})();(function(){"use strict";var PIx2=Math.PI*2-1e-4;Konva.Ring=function(config){this.___init(config)};Konva.Ring.prototype={_centroid:true,___init:function(config){Konva.Shape.call(this,config);this.className="Ring";this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){context.beginPath();context.arc(0,0,this.getInnerRadius(),0,PIx2,false);context.moveTo(this.getOuterRadius(),0);context.arc(0,0,this.getOuterRadius(),PIx2,0,true);context.closePath();context.fillStrokeShape(this)},getWidth:function(){return this.getOuterRadius()*2},getHeight:function(){return this.getOuterRadius()*2},setWidth:function(width){Konva.Node.prototype.setWidth.call(this,width);if(this.outerRadius()!==width/2){this.setOuterRadius(width/2)}},setHeight:function(height){Konva.Node.prototype.setHeight.call(this,height);if(this.outerRadius()!==height/2){this.setOuterRadius(height/2)}},setOuterRadius:function(val){this._setAttr("outerRadius",val);this.setWidth(val*2);this.setHeight(val*2)}};Konva.Util.extend(Konva.Ring,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Ring,"innerRadius",0);Konva.Factory.addGetter(Konva.Ring,"outerRadius",0);Konva.Factory.addOverloadedGetterSetter(Konva.Ring,"outerRadius");Konva.Collection.mapMethods(Konva.Ring)})();(function(){"use strict";Konva.Wedge=function(config){this.___init(config)};Konva.Wedge.prototype={_centroid:true,___init:function(config){Konva.Shape.call(this,config);this.className="Wedge";this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){context.beginPath();context.arc(0,0,this.getRadius(),0,Konva.getAngle(this.getAngle()),this.getClockwise());context.lineTo(0,0);context.closePath();context.fillStrokeShape(this)},getWidth:function(){return this.getRadius()*2},getHeight:function(){return this.getRadius()*2},setWidth:function(width){Konva.Node.prototype.setWidth.call(this,width);if(this.radius()!==width/2){this.setRadius(width/2)}},setHeight:function(height){Konva.Node.prototype.setHeight.call(this,height);if(this.radius()!==height/2){this.setRadius(height/2)}}};Konva.Util.extend(Konva.Wedge,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Wedge,"radius",0);Konva.Factory.addGetterSetter(Konva.Wedge,"angle",0);Konva.Factory.addGetterSetter(Konva.Wedge,"clockwise",false);Konva.Factory.backCompat(Konva.Wedge,{angleDeg:"angle",getAngleDeg:"getAngle",setAngleDeg:"setAngle"});Konva.Collection.mapMethods(Konva.Wedge)})();(function(){"use strict";Konva.Arc=function(config){this.___init(config)};Konva.Arc.prototype={_centroid:true,___init:function(config){Konva.Shape.call(this,config);this.className="Arc";this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var angle=Konva.getAngle(this.angle()),clockwise=this.clockwise();context.beginPath();context.arc(0,0,this.getOuterRadius(),0,angle,clockwise);context.arc(0,0,this.getInnerRadius(),angle,0,!clockwise);context.closePath();context.fillStrokeShape(this)},getWidth:function(){return this.getOuterRadius()*2},getHeight:function(){return this.getOuterRadius()*2},setWidth:function(width){Konva.Node.prototype.setWidth.call(this,width);if(this.getOuterRadius()!==width/2){this.setOuterRadius(width/2)}},setHeight:function(height){Konva.Node.prototype.setHeight.call(this,height);if(this.getOuterRadius()!==height/2){this.setOuterRadius(height/2)}}};Konva.Util.extend(Konva.Arc,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Arc,"innerRadius",0);Konva.Factory.addGetterSetter(Konva.Arc,"outerRadius",0);Konva.Factory.addGetterSetter(Konva.Arc,"angle",0);Konva.Factory.addGetterSetter(Konva.Arc,"clockwise",false);Konva.Collection.mapMethods(Konva.Arc)})();(function(){"use strict";var IMAGE="Image";Konva.Image=function(config){this.___init(config)};Konva.Image.prototype={___init:function(config){Konva.Shape.call(this,config);this.className=IMAGE;this.sceneFunc(this._sceneFunc);this.hitFunc(this._hitFunc)},_useBufferCanvas:function(){return(this.hasShadow()||this.getAbsoluteOpacity()!==1)&&this.hasStroke()&&this.getStage()},_sceneFunc:function(context){var width=this.getWidth(),height=this.getHeight(),image=this.getImage(),cropWidth,cropHeight,params;if(image){cropWidth=this.getCropWidth();cropHeight=this.getCropHeight();if(cropWidth&&cropHeight){params=[image,this.getCropX(),this.getCropY(),cropWidth,cropHeight,0,0,width,height]}else{params=[image,0,0,width,height]}}if(this.hasFill()||this.hasStroke()){context.beginPath();context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this)}if(image){context.drawImage.apply(context,params)}},_hitFunc:function(context){var width=this.getWidth(),height=this.getHeight();context.beginPath();context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this)},getWidth:function(){var image=this.getImage();return this.attrs.width||(image?image.width:0)},getHeight:function(){var image=this.getImage();return this.attrs.height||(image?image.height:0)}};Konva.Util.extend(Konva.Image,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Image,"image");Konva.Factory.addComponentsGetterSetter(Konva.Image,"crop",["x","y","width","height"]);Konva.Factory.addGetterSetter(Konva.Image,"cropX",0);Konva.Factory.addGetterSetter(Konva.Image,"cropY",0);Konva.Factory.addGetterSetter(Konva.Image,"cropWidth",0);Konva.Factory.addGetterSetter(Konva.Image,"cropHeight",0);Konva.Collection.mapMethods(Konva.Image);Konva.Image.fromURL=function(url,callback){var img=new Image;img.onload=function(){var image=new Konva.Image({image:img});callback(image)};img.src=url}})();(function(){"use strict";var AUTO="auto",CENTER="center",CHANGE_KONVA="Change.konva",CONTEXT_2D="2d",DASH="-",EMPTY_STRING="",LEFT="left",TEXT="text",TEXT_UPPER="Text",MIDDLE="middle",NORMAL="normal",PX_SPACE="px ",SPACE=" ",RIGHT="right",WORD="word",CHAR="char",NONE="none",ATTR_CHANGE_LIST=["fontFamily","fontSize","fontStyle","fontVariant","padding","align","lineHeight","text","width","height","wrap"],attrChangeListLen=ATTR_CHANGE_LIST.length,dummyContext=Konva.Util.createCanvasElement().getContext(CONTEXT_2D);Konva.Text=function(config){this.___init(config)};function _fillFunc(context){context.fillText(this.partialText,0,0)}function _strokeFunc(context){context.strokeText(this.partialText,0,0)}Konva.Text.prototype={___init:function(config){config=config||{};if(!config.fillLinearGradientColorStops&&!config.fillRadialGradientColorStops){config.fill=config.fill||"black"}if(config.width===undefined){config.width=AUTO}if(config.height===undefined){config.height=AUTO}Konva.Shape.call(this,config);this._fillFunc=_fillFunc;this._strokeFunc=_strokeFunc;this.className=TEXT_UPPER;for(var n=0;n<attrChangeListLen;n++){this.on(ATTR_CHANGE_LIST[n]+CHANGE_KONVA,this._setTextData)}this._setTextData();this.sceneFunc(this._sceneFunc);this.hitFunc(this._hitFunc)},_sceneFunc:function(context){var p=this.getPadding(),textHeight=this.getTextHeight(),lineHeightPx=this.getLineHeight()*textHeight,textArr=this.textArr,textArrLen=textArr.length,totalWidth=this.getWidth(),n;context.setAttr("font",this._getContextFont());context.setAttr("textBaseline",MIDDLE);context.setAttr("textAlign",LEFT);context.save();if(p){context.translate(p,0);context.translate(0,p+textHeight/2)}else{context.translate(0,textHeight/2)}for(n=0;n<textArrLen;n++){var obj=textArr[n],text=obj.text,width=obj.width;context.save();if(this.getAlign()===RIGHT){context.translate(totalWidth-width-p*2,0)}else if(this.getAlign()===CENTER){context.translate((totalWidth-width-p*2)/2,0)}this.partialText=text;context.fillStrokeShape(this);context.restore();context.translate(0,lineHeightPx)}context.restore()},_hitFunc:function(context){var width=this.getWidth(),height=this.getHeight();context.beginPath();context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this)},setText:function(text){var str=Konva.Util._isString(text)?text:text.toString();this._setAttr(TEXT,str);return this},getWidth:function(){return this.attrs.width===AUTO?this.getTextWidth()+this.getPadding()*2:this.attrs.width},getHeight:function(){return this.attrs.height===AUTO?this.getTextHeight()*this.textArr.length*this.getLineHeight()+this.getPadding()*2:this.attrs.height},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(text){var _context=dummyContext,fontSize=this.getFontSize(),metrics;_context.save();_context.font=this._getContextFont();metrics=_context.measureText(text);_context.restore();return{width:metrics.width,height:parseInt(fontSize,10)}},_getContextFont:function(){if(Konva.UA.isIE){return this.getFontStyle()+SPACE+this.getFontSize()+PX_SPACE+this.getFontFamily()}return this.getFontStyle()+SPACE+this.getFontVariant()+SPACE+this.getFontSize()+PX_SPACE+this.getFontFamily()},_addTextLine:function(line,width){return this.textArr.push({text:line,width:width})},_getTextWidth:function(text){return dummyContext.measureText(text).width},_setTextData:function(){var lines=this.getText().split("\n"),fontSize=+this.getFontSize(),textWidth=0,lineHeightPx=this.getLineHeight()*fontSize,width=this.attrs.width,height=this.attrs.height,fixedWidth=width!==AUTO,fixedHeight=height!==AUTO,padding=this.getPadding(),maxWidth=width-padding*2,maxHeightPx=height-padding*2,currentHeightPx=0,wrap=this.getWrap(),shouldWrap=wrap!==NONE,wrapAtWord=wrap!==CHAR&&shouldWrap;this.textArr=[];dummyContext.save();dummyContext.font=this._getContextFont();for(var i=0,max=lines.length;i<max;++i){var line=lines[i],lineWidth=this._getTextWidth(line);if(fixedWidth&&lineWidth>maxWidth){while(line.length>0){var low=0,high=line.length,match="",matchWidth=0;while(low<high){var mid=low+high>>>1,substr=line.slice(0,mid+1),substrWidth=this._getTextWidth(substr);if(substrWidth<=maxWidth){low=mid+1;match=substr;matchWidth=substrWidth}else{high=mid}}if(match){if(wrapAtWord){var wrapIndex=Math.max(match.lastIndexOf(SPACE),match.lastIndexOf(DASH))+1;if(wrapIndex>0){low=wrapIndex;match=match.slice(0,low);matchWidth=this._getTextWidth(match)}}this._addTextLine(match,matchWidth);textWidth=Math.max(textWidth,matchWidth);currentHeightPx+=lineHeightPx;if(!shouldWrap||fixedHeight&&currentHeightPx+lineHeightPx>maxHeightPx){break}line=line.slice(low);if(line.length>0){lineWidth=this._getTextWidth(line);if(lineWidth<=maxWidth){this._addTextLine(line,lineWidth);currentHeightPx+=lineHeightPx;textWidth=Math.max(textWidth,lineWidth);break}}}else{break}}}else{this._addTextLine(line,lineWidth);currentHeightPx+=lineHeightPx;textWidth=Math.max(textWidth,lineWidth)}if(fixedHeight&&currentHeightPx+lineHeightPx>maxHeightPx){break}}dummyContext.restore();this.textHeight=fontSize;this.textWidth=textWidth}};Konva.Util.extend(Konva.Text,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Text,"fontFamily","Arial");Konva.Factory.addGetterSetter(Konva.Text,"fontSize",12);Konva.Factory.addGetterSetter(Konva.Text,"fontStyle",NORMAL);Konva.Factory.addGetterSetter(Konva.Text,"fontVariant",NORMAL);Konva.Factory.addGetterSetter(Konva.Text,"padding",0);Konva.Factory.addGetterSetter(Konva.Text,"align",LEFT);Konva.Factory.addGetterSetter(Konva.Text,"lineHeight",1);Konva.Factory.addGetterSetter(Konva.Text,"wrap",WORD);Konva.Factory.addGetter(Konva.Text,"text",EMPTY_STRING);Konva.Factory.addOverloadedGetterSetter(Konva.Text,"text");Konva.Collection.mapMethods(Konva.Text)})();(function(){"use strict";Konva.Line=function(config){this.___init(config)};Konva.Line.prototype={___init:function(config){Konva.Shape.call(this,config);this.className="Line";this.on("pointsChange.konva tensionChange.konva closedChange.konva",function(){this._clearCache("tensionPoints")});this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var points=this.getPoints(),length=points.length,tension=this.getTension(),closed=this.getClosed(),tp,len,n;if(!length){return}context.beginPath();context.moveTo(points[0],points[1]);if(tension!==0&&length>4){tp=this.getTensionPoints();len=tp.length;n=closed?0:4;if(!closed){context.quadraticCurveTo(tp[0],tp[1],tp[2],tp[3])}while(n<len-2){context.bezierCurveTo(tp[n++],tp[n++],tp[n++],tp[n++],tp[n++],tp[n++])}if(!closed){context.quadraticCurveTo(tp[len-2],tp[len-1],points[length-2],points[length-1])}}else{for(n=2;n<length;n+=2){context.lineTo(points[n],points[n+1])}}if(closed){context.closePath();context.fillStrokeShape(this)}else{context.strokeShape(this)}},getTensionPoints:function(){return this._getCache("tensionPoints",this._getTensionPoints)},_getTensionPoints:function(){if(this.getClosed()){return this._getTensionPointsClosed()}else{return Konva.Util._expandPoints(this.getPoints(),this.getTension())}},_getTensionPointsClosed:function(){var p=this.getPoints(),len=p.length,tension=this.getTension(),util=Konva.Util,firstControlPoints=util._getControlPoints(p[len-2],p[len-1],p[0],p[1],p[2],p[3],tension),lastControlPoints=util._getControlPoints(p[len-4],p[len-3],p[len-2],p[len-1],p[0],p[1],tension),middle=Konva.Util._expandPoints(p,tension),tp=[firstControlPoints[2],firstControlPoints[3]].concat(middle).concat([lastControlPoints[0],lastControlPoints[1],p[len-2],p[len-1],lastControlPoints[2],lastControlPoints[3],firstControlPoints[0],firstControlPoints[1],p[0],p[1]]);return tp},getWidth:function(){return this.getSelfRect().width},getHeight:function(){return this.getSelfRect().height},getSelfRect:function(){var points;if(this.getTension()!==0){points=this._getTensionPoints()}else{points=this.getPoints()}var minX=points[0];var maxX=points[0];var minY=points[1];var maxY=points[1];var x,y;for(var i=0;i<points.length/2;i++){x=points[i*2];y=points[i*2+1];minX=Math.min(minX,x);maxX=Math.max(maxX,x);minY=Math.min(minY,y);maxY=Math.max(maxY,y)}return{x:Math.round(minX),y:Math.round(minY),width:Math.round(maxX-minX),height:Math.round(maxY-minY)}}};Konva.Util.extend(Konva.Line,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Line,"closed",false);Konva.Factory.addGetterSetter(Konva.Line,"tension",0);Konva.Factory.addGetterSetter(Konva.Line,"points",[]);Konva.Collection.mapMethods(Konva.Line)})();(function(){"use strict";Konva.Sprite=function(config){this.___init(config)};Konva.Sprite.prototype={___init:function(config){Konva.Shape.call(this,config);this.className="Sprite";this._updated=true;var that=this;this.anim=new Konva.Animation(function(){var updated=that._updated;that._updated=false;return updated});this.on("animationChange.konva",function(){this.frameIndex(0)});this.on("frameIndexChange.konva",function(){this._updated=true});this.on("frameRateChange.konva",function(){if(!this.anim.isRunning()){return}clearInterval(this.interval);this._setInterval()});this.sceneFunc(this._sceneFunc);this.hitFunc(this._hitFunc)},_sceneFunc:function(context){var anim=this.getAnimation(),index=this.frameIndex(),ix4=index*4,set=this.getAnimations()[anim],offsets=this.frameOffsets(),x=set[ix4+0],y=set[ix4+1],width=set[ix4+2],height=set[ix4+3],image=this.getImage();if(this.hasFill()||this.hasStroke()){context.beginPath();context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this)}if(image){if(offsets){var offset=offsets[anim],ix2=index*2;context.drawImage(image,x,y,width,height,offset[ix2+0],offset[ix2+1],width,height)}else{context.drawImage(image,x,y,width,height,0,0,width,height)}}},_hitFunc:function(context){var anim=this.getAnimation(),index=this.frameIndex(),ix4=index*4,set=this.getAnimations()[anim],offsets=this.frameOffsets(),width=set[ix4+2],height=set[ix4+3];context.beginPath();if(offsets){var offset=offsets[anim];var ix2=index*2;context.rect(offset[ix2+0],offset[ix2+1],width,height)}else{context.rect(0,0,width,height)}context.closePath();context.fillShape(this)},_useBufferCanvas:function(){return(this.hasShadow()||this.getAbsoluteOpacity()!==1)&&this.hasStroke()},_setInterval:function(){var that=this;this.interval=setInterval(function(){that._updateIndex()},1e3/this.getFrameRate())},start:function(){var layer=this.getLayer();this.anim.setLayers(layer);this._setInterval();this.anim.start()},stop:function(){this.anim.stop();clearInterval(this.interval)},isRunning:function(){return this.anim.isRunning()},_updateIndex:function(){var index=this.frameIndex(),animation=this.getAnimation(),animations=this.getAnimations(),anim=animations[animation],len=anim.length/4;if(index<len-1){this.frameIndex(index+1)}else{this.frameIndex(0)}}};Konva.Util.extend(Konva.Sprite,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Sprite,"animation");Konva.Factory.addGetterSetter(Konva.Sprite,"animations");Konva.Factory.addGetterSetter(Konva.Sprite,"frameOffsets");Konva.Factory.addGetterSetter(Konva.Sprite,"image");Konva.Factory.addGetterSetter(Konva.Sprite,"frameIndex",0);Konva.Factory.addGetterSetter(Konva.Sprite,"frameRate",17);Konva.Factory.backCompat(Konva.Sprite,{index:"frameIndex",getIndex:"getFrameIndex",setIndex:"setFrameIndex"});Konva.Collection.mapMethods(Konva.Sprite)})();(function(){"use strict";Konva.Path=function(config){this.___init(config)};Konva.Path.prototype={___init:function(config){this.dataArray=[];var that=this;Konva.Shape.call(this,config);this.className="Path";this.dataArray=Konva.Path.parsePathData(this.getData());this.on("dataChange.konva",function(){that.dataArray=Konva.Path.parsePathData(this.getData())});this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var ca=this.dataArray;context.beginPath();for(var n=0;n<ca.length;n++){var c=ca[n].command;var p=ca[n].points;switch(c){case"L":context.lineTo(p[0],p[1]);break;case"M":context.moveTo(p[0],p[1]);break;case"C":context.bezierCurveTo(p[0],p[1],p[2],p[3],p[4],p[5]);break;case"Q":context.quadraticCurveTo(p[0],p[1],p[2],p[3]);break;case"A":var cx=p[0],cy=p[1],rx=p[2],ry=p[3],theta=p[4],dTheta=p[5],psi=p[6],fs=p[7];var r=rx>ry?rx:ry;var scaleX=rx>ry?1:rx/ry;var scaleY=rx>ry?ry/rx:1;context.translate(cx,cy);context.rotate(psi);context.scale(scaleX,scaleY);context.arc(0,0,r,theta,theta+dTheta,1-fs);context.scale(1/scaleX,1/scaleY);context.rotate(-psi);context.translate(-cx,-cy);break;case"z":context.closePath();break}}context.fillStrokeShape(this)},getSelfRect:function(){var points=[];this.dataArray.forEach(function(data){points=points.concat(data.points)});var minX=points[0];var maxX=points[0];var minY=points[1];var maxY=points[1];var x,y;for(var i=0;i<points.length/2;i++){x=points[i*2];y=points[i*2+1];minX=Math.min(minX,x);maxX=Math.max(maxX,x);minY=Math.min(minY,y);maxY=Math.max(maxY,y)}return{x:Math.round(minX),y:Math.round(minY),width:Math.round(maxX-minX),height:Math.round(maxY-minY)}}};Konva.Util.extend(Konva.Path,Konva.Shape);Konva.Path.getLineLength=function(x1,y1,x2,y2){return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1))};Konva.Path.getPointOnLine=function(dist,P1x,P1y,P2x,P2y,fromX,fromY){if(fromX===undefined){fromX=P1x}if(fromY===undefined){fromY=P1y}var m=(P2y-P1y)/(P2x-P1x+1e-8);var run=Math.sqrt(dist*dist/(1+m*m));if(P2x<P1x){run*=-1}var rise=m*run;var pt;if(P2x===P1x){pt={x:fromX,y:fromY+rise}}else if((fromY-P1y)/(fromX-P1x+1e-8)===m){pt={x:fromX+run,y:fromY+rise}}else{var ix,iy;var len=this.getLineLength(P1x,P1y,P2x,P2y);if(len<1e-8){return undefined}var u=(fromX-P1x)*(P2x-P1x)+(fromY-P1y)*(P2y-P1y);u=u/(len*len);ix=P1x+u*(P2x-P1x);iy=P1y+u*(P2y-P1y);var pRise=this.getLineLength(fromX,fromY,ix,iy);var pRun=Math.sqrt(dist*dist-pRise*pRise);run=Math.sqrt(pRun*pRun/(1+m*m));if(P2x<P1x){run*=-1}rise=m*run;pt={x:ix+run,y:iy+rise}}return pt};Konva.Path.getPointOnCubicBezier=function(pct,P1x,P1y,P2x,P2y,P3x,P3y,P4x,P4y){function CB1(t){return t*t*t}function CB2(t){return 3*t*t*(1-t)}function CB3(t){return 3*t*(1-t)*(1-t)}function CB4(t){return(1-t)*(1-t)*(1-t)}var x=P4x*CB1(pct)+P3x*CB2(pct)+P2x*CB3(pct)+P1x*CB4(pct);var y=P4y*CB1(pct)+P3y*CB2(pct)+P2y*CB3(pct)+P1y*CB4(pct);return{x:x,y:y}};Konva.Path.getPointOnQuadraticBezier=function(pct,P1x,P1y,P2x,P2y,P3x,P3y){function QB1(t){return t*t}function QB2(t){return 2*t*(1-t)}function QB3(t){return(1-t)*(1-t)}var x=P3x*QB1(pct)+P2x*QB2(pct)+P1x*QB3(pct);var y=P3y*QB1(pct)+P2y*QB2(pct)+P1y*QB3(pct);return{x:x,y:y}};Konva.Path.getPointOnEllipticalArc=function(cx,cy,rx,ry,theta,psi){var cosPsi=Math.cos(psi),sinPsi=Math.sin(psi);var pt={x:rx*Math.cos(theta),y:ry*Math.sin(theta)};return{x:cx+(pt.x*cosPsi-pt.y*sinPsi),y:cy+(pt.x*sinPsi+pt.y*cosPsi)}};Konva.Path.parsePathData=function(data){if(!data){return[]}var cs=data;var cc=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];cs=cs.replace(new RegExp(" ","g"),",");for(var n=0;n<cc.length;n++){cs=cs.replace(new RegExp(cc[n],"g"),"|"+cc[n])}var arr=cs.split("|");var ca=[];var cpx=0;var cpy=0;for(n=1;n<arr.length;n++){var str=arr[n];var c=str.charAt(0);str=str.slice(1);str=str.replace(new RegExp(",-","g"),"-");str=str.replace(new RegExp("-","g"),",-");str=str.replace(new RegExp("e,-","g"),"e-");var p=str.split(",");if(p.length>0&&p[0]===""){p.shift()}for(var i=0;i<p.length;i++){p[i]=parseFloat(p[i])}while(p.length>0){if(isNaN(p[0])){break}var cmd=null;var points=[];var startX=cpx,startY=cpy;var prevCmd,ctlPtx,ctlPty;var rx,ry,psi,fa,fs,x1,y1;switch(c){case"l":cpx+=p.shift();cpy+=p.shift();cmd="L";points.push(cpx,cpy);break;case"L":cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case"m":var dx=p.shift();var dy=p.shift();cpx+=dx;cpy+=dy;cmd="M";if(ca.length>2&&ca[ca.length-1].command==="z"){for(var idx=ca.length-2;idx>=0;idx--){if(ca[idx].command==="M"){cpx=ca[idx].points[0]+dx;cpy=ca[idx].points[1]+dy;break}}}points.push(cpx,cpy);c="l";break;case"M":cpx=p.shift();cpy=p.shift();cmd="M";points.push(cpx,cpy);c="L";break;case"h":cpx+=p.shift();cmd="L";points.push(cpx,cpy);break;case"H":cpx=p.shift();cmd="L";points.push(cpx,cpy);break;case"v":cpy+=p.shift();cmd="L";points.push(cpx,cpy);break;case"V":cpy=p.shift();cmd="L";points.push(cpx,cpy);break;case"C":points.push(p.shift(),p.shift(),p.shift(),p.shift());cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case"c":points.push(cpx+p.shift(),cpy+p.shift(),cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd="C";points.push(cpx,cpy);break;case"S":ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==="C"){ctlPtx=cpx+(cpx-prevCmd.points[2]);ctlPty=cpy+(cpy-prevCmd.points[3])}points.push(ctlPtx,ctlPty,p.shift(),p.shift());cpx=p.shift();cpy=p.shift();cmd="C";points.push(cpx,cpy);break;case"s":ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==="C"){ctlPtx=cpx+(cpx-prevCmd.points[2]);ctlPty=cpy+(cpy-prevCmd.points[3])}points.push(ctlPtx,ctlPty,cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd="C";points.push(cpx,cpy);
break;case"Q":points.push(p.shift(),p.shift());cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case"q":points.push(cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd="Q";points.push(cpx,cpy);break;case"T":ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==="Q"){ctlPtx=cpx+(cpx-prevCmd.points[0]);ctlPty=cpy+(cpy-prevCmd.points[1])}cpx=p.shift();cpy=p.shift();cmd="Q";points.push(ctlPtx,ctlPty,cpx,cpy);break;case"t":ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==="Q"){ctlPtx=cpx+(cpx-prevCmd.points[0]);ctlPty=cpy+(cpy-prevCmd.points[1])}cpx+=p.shift();cpy+=p.shift();cmd="Q";points.push(ctlPtx,ctlPty,cpx,cpy);break;case"A":rx=p.shift();ry=p.shift();psi=p.shift();fa=p.shift();fs=p.shift();x1=cpx;y1=cpy;cpx=p.shift();cpy=p.shift();cmd="A";points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi);break;case"a":rx=p.shift();ry=p.shift();psi=p.shift();fa=p.shift();fs=p.shift();x1=cpx;y1=cpy;cpx+=p.shift();cpy+=p.shift();cmd="A";points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi);break}ca.push({command:cmd||c,points:points,start:{x:startX,y:startY},pathLength:this.calcLength(startX,startY,cmd||c,points)})}if(c==="z"||c==="Z"){ca.push({command:"z",points:[],start:undefined,pathLength:0})}}return ca};Konva.Path.calcLength=function(x,y,cmd,points){var len,p1,p2,t;var path=Konva.Path;switch(cmd){case"L":return path.getLineLength(x,y,points[0],points[1]);case"C":len=0;p1=path.getPointOnCubicBezier(0,x,y,points[0],points[1],points[2],points[3],points[4],points[5]);for(t=.01;t<=1;t+=.01){p2=path.getPointOnCubicBezier(t,x,y,points[0],points[1],points[2],points[3],points[4],points[5]);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2}return len;case"Q":len=0;p1=path.getPointOnQuadraticBezier(0,x,y,points[0],points[1],points[2],points[3]);for(t=.01;t<=1;t+=.01){p2=path.getPointOnQuadraticBezier(t,x,y,points[0],points[1],points[2],points[3]);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2}return len;case"A":len=0;var start=points[4];var dTheta=points[5];var end=points[4]+dTheta;var inc=Math.PI/180;if(Math.abs(start-end)<inc){inc=Math.abs(start-end)}p1=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],start,0);if(dTheta<0){for(t=start-inc;t>end;t-=inc){p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2}}else{for(t=start+inc;t<end;t+=inc){p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2}}p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],end,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);return len}return 0};Konva.Path.convertEndpointToCenterParameterization=function(x1,y1,x2,y2,fa,fs,rx,ry,psiDeg){var psi=psiDeg*(Math.PI/180);var xp=Math.cos(psi)*(x1-x2)/2+Math.sin(psi)*(y1-y2)/2;var yp=-1*Math.sin(psi)*(x1-x2)/2+Math.cos(psi)*(y1-y2)/2;var lambda=xp*xp/(rx*rx)+yp*yp/(ry*ry);if(lambda>1){rx*=Math.sqrt(lambda);ry*=Math.sqrt(lambda)}var f=Math.sqrt((rx*rx*(ry*ry)-rx*rx*(yp*yp)-ry*ry*(xp*xp))/(rx*rx*(yp*yp)+ry*ry*(xp*xp)));if(fa===fs){f*=-1}if(isNaN(f)){f=0}var cxp=f*rx*yp/ry;var cyp=f*-ry*xp/rx;var cx=(x1+x2)/2+Math.cos(psi)*cxp-Math.sin(psi)*cyp;var cy=(y1+y2)/2+Math.sin(psi)*cxp+Math.cos(psi)*cyp;var vMag=function(v){return Math.sqrt(v[0]*v[0]+v[1]*v[1])};var vRatio=function(u,v){return(u[0]*v[0]+u[1]*v[1])/(vMag(u)*vMag(v))};var vAngle=function(u,v){return(u[0]*v[1]<u[1]*v[0]?-1:1)*Math.acos(vRatio(u,v))};var theta=vAngle([1,0],[(xp-cxp)/rx,(yp-cyp)/ry]);var u=[(xp-cxp)/rx,(yp-cyp)/ry];var v=[(-1*xp-cxp)/rx,(-1*yp-cyp)/ry];var dTheta=vAngle(u,v);if(vRatio(u,v)<=-1){dTheta=Math.PI}if(vRatio(u,v)>=1){dTheta=0}if(fs===0&&dTheta>0){dTheta=dTheta-2*Math.PI}if(fs===1&&dTheta<0){dTheta=dTheta+2*Math.PI}return[cx,cy,rx,ry,theta,dTheta,psi,fs]};Konva.Factory.addGetterSetter(Konva.Path,"data");Konva.Collection.mapMethods(Konva.Path)})();(function(){"use strict";var EMPTY_STRING="",NORMAL="normal";Konva.TextPath=function(config){this.___init(config)};function _fillFunc(context){context.fillText(this.partialText,0,0)}function _strokeFunc(context){context.strokeText(this.partialText,0,0)}Konva.TextPath.prototype={___init:function(config){var that=this;this.dummyCanvas=Konva.Util.createCanvasElement();this.dataArray=[];Konva.Shape.call(this,config);this._fillFunc=_fillFunc;this._strokeFunc=_strokeFunc;this._fillFuncHit=_fillFunc;this._strokeFuncHit=_strokeFunc;this.className="TextPath";this.dataArray=Konva.Path.parsePathData(this.attrs.data);this.on("dataChange.konva",function(){that.dataArray=Konva.Path.parsePathData(this.attrs.data)});this.on("textChange.konva textStroke.konva textStrokeWidth.konva",that._setTextData);that._setTextData();this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){context.setAttr("font",this._getContextFont());context.setAttr("textBaseline","middle");context.setAttr("textAlign","left");context.save();var glyphInfo=this.glyphInfo;for(var i=0;i<glyphInfo.length;i++){context.save();var p0=glyphInfo[i].p0;context.translate(p0.x,p0.y);context.rotate(glyphInfo[i].rotation);this.partialText=glyphInfo[i].text;context.fillStrokeShape(this);context.restore()}context.restore()},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},setText:function(text){Konva.Text.prototype.setText.call(this,text)},_getTextSize:function(text){var dummyCanvas=this.dummyCanvas;var _context=dummyCanvas.getContext("2d");_context.save();_context.font=this._getContextFont();var metrics=_context.measureText(text);_context.restore();return{width:metrics.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var that=this;var size=this._getTextSize(this.attrs.text);this.textWidth=size.width;this.textHeight=size.height;this.glyphInfo=[];var charArr=this.attrs.text.split("");var p0,p1,pathCmd;var pIndex=-1;var currentT=0;var getNextPathSegment=function(){currentT=0;var pathData=that.dataArray;for(var j=pIndex+1;j<pathData.length;j++){if(pathData[j].pathLength>0){pIndex=j;return pathData[j]}else if(pathData[j].command==="M"){p0={x:pathData[j].points[0],y:pathData[j].points[1]}}}return{}};var findSegmentToFitCharacter=function(c){var glyphWidth=that._getTextSize(c).width;var currLen=0;var attempts=0;p1=undefined;while(Math.abs(glyphWidth-currLen)/glyphWidth>.01&&attempts<25){attempts++;var cumulativePathLength=currLen;while(pathCmd===undefined){pathCmd=getNextPathSegment();if(pathCmd&&cumulativePathLength+pathCmd.pathLength<glyphWidth){cumulativePathLength+=pathCmd.pathLength;pathCmd=undefined}}if(pathCmd==={}||p0===undefined){return undefined}var needNewSegment=false;switch(pathCmd.command){case"L":if(Konva.Path.getLineLength(p0.x,p0.y,pathCmd.points[0],pathCmd.points[1])>glyphWidth){p1=Konva.Path.getPointOnLine(glyphWidth,p0.x,p0.y,pathCmd.points[0],pathCmd.points[1],p0.x,p0.y)}else{pathCmd=undefined}break;case"A":var start=pathCmd.points[4];var dTheta=pathCmd.points[5];var end=pathCmd.points[4]+dTheta;if(currentT===0){currentT=start+1e-8}else if(glyphWidth>currLen){currentT+=Math.PI/180*dTheta/Math.abs(dTheta)}else{currentT-=Math.PI/360*dTheta/Math.abs(dTheta)}if(dTheta<0&&currentT<end||dTheta>=0&&currentT>end){currentT=end;needNewSegment=true}p1=Konva.Path.getPointOnEllipticalArc(pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3],currentT,pathCmd.points[6]);break;case"C":if(currentT===0){if(glyphWidth>pathCmd.pathLength){currentT=1e-8}else{currentT=glyphWidth/pathCmd.pathLength}}else if(glyphWidth>currLen){currentT+=(glyphWidth-currLen)/pathCmd.pathLength}else{currentT-=(currLen-glyphWidth)/pathCmd.pathLength}if(currentT>1){currentT=1;needNewSegment=true}p1=Konva.Path.getPointOnCubicBezier(currentT,pathCmd.start.x,pathCmd.start.y,pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3],pathCmd.points[4],pathCmd.points[5]);break;case"Q":if(currentT===0){currentT=glyphWidth/pathCmd.pathLength}else if(glyphWidth>currLen){currentT+=(glyphWidth-currLen)/pathCmd.pathLength}else{currentT-=(currLen-glyphWidth)/pathCmd.pathLength}if(currentT>1){currentT=1;needNewSegment=true}p1=Konva.Path.getPointOnQuadraticBezier(currentT,pathCmd.start.x,pathCmd.start.y,pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3]);break}if(p1!==undefined){currLen=Konva.Path.getLineLength(p0.x,p0.y,p1.x,p1.y)}if(needNewSegment){needNewSegment=false;pathCmd=undefined}}};for(var i=0;i<charArr.length;i++){findSegmentToFitCharacter(charArr[i]);if(p0===undefined||p1===undefined){break}var width=Konva.Path.getLineLength(p0.x,p0.y,p1.x,p1.y);var kern=0;var midpoint=Konva.Path.getPointOnLine(kern+width/2,p0.x,p0.y,p1.x,p1.y);var rotation=Math.atan2(p1.y-p0.y,p1.x-p0.x);this.glyphInfo.push({transposeX:midpoint.x,transposeY:midpoint.y,text:charArr[i],rotation:rotation,p0:p0,p1:p1});p0=p1}},getSelfRect:function(){var points=[];var fontSize=this.fontSize();this.glyphInfo.forEach(function(info){points.push(info.p0.x);points.push(info.p0.y);points.push(info.p1.x);points.push(info.p1.y)});var minX=points[0];var maxX=points[0];var minY=points[0];var maxY=points[0];var x,y;for(var i=0;i<points.length/2;i++){x=points[i*2];y=points[i*2+1];minX=Math.min(minX,x);maxX=Math.max(maxX,x);minY=Math.min(minY,y);maxY=Math.max(maxY,y)}return{x:Math.round(minX)-fontSize,y:Math.round(minY)-fontSize,width:Math.round(maxX-minX)+fontSize*2,height:Math.round(maxY-minY)+fontSize*2}}};Konva.TextPath.prototype._getContextFont=Konva.Text.prototype._getContextFont;Konva.Util.extend(Konva.TextPath,Konva.Shape);Konva.Factory.addGetterSetter(Konva.TextPath,"fontFamily","Arial");Konva.Factory.addGetterSetter(Konva.TextPath,"fontSize",12);Konva.Factory.addGetterSetter(Konva.TextPath,"fontStyle",NORMAL);Konva.Factory.addGetterSetter(Konva.TextPath,"fontVariant",NORMAL);Konva.Factory.addGetter(Konva.TextPath,"text",EMPTY_STRING);Konva.Collection.mapMethods(Konva.TextPath)})();(function(){"use strict";Konva.RegularPolygon=function(config){this.___init(config)};Konva.RegularPolygon.prototype={_centroid:true,___init:function(config){Konva.Shape.call(this,config);this.className="RegularPolygon";this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var sides=this.attrs.sides,radius=this.attrs.radius,n,x,y;context.beginPath();context.moveTo(0,0-radius);for(n=1;n<sides;n++){x=radius*Math.sin(n*2*Math.PI/sides);y=-1*radius*Math.cos(n*2*Math.PI/sides);context.lineTo(x,y)}context.closePath();context.fillStrokeShape(this)},getWidth:function(){return this.getRadius()*2},getHeight:function(){return this.getRadius()*2},setWidth:function(width){Konva.Node.prototype.setWidth.call(this,width);if(this.radius()!==width/2){this.setRadius(width/2)}},setHeight:function(height){Konva.Node.prototype.setHeight.call(this,height);if(this.radius()!==height/2){this.setRadius(height/2)}}};Konva.Util.extend(Konva.RegularPolygon,Konva.Shape);Konva.Factory.addGetterSetter(Konva.RegularPolygon,"radius",0);Konva.Factory.addGetterSetter(Konva.RegularPolygon,"sides",0);Konva.Collection.mapMethods(Konva.RegularPolygon)})();(function(){"use strict";Konva.Star=function(config){this.___init(config)};Konva.Star.prototype={_centroid:true,___init:function(config){Konva.Shape.call(this,config);this.className="Star";this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var innerRadius=this.innerRadius(),outerRadius=this.outerRadius(),numPoints=this.numPoints();context.beginPath();context.moveTo(0,0-outerRadius);for(var n=1;n<numPoints*2;n++){var radius=n%2===0?outerRadius:innerRadius;var x=radius*Math.sin(n*Math.PI/numPoints);var y=-1*radius*Math.cos(n*Math.PI/numPoints);context.lineTo(x,y)}context.closePath();context.fillStrokeShape(this)},getWidth:function(){return this.getOuterRadius()*2},getHeight:function(){return this.getOuterRadius()*2},setWidth:function(width){Konva.Node.prototype.setWidth.call(this,width);if(this.outerRadius()!==width/2){this.setOuterRadius(width/2)}},setHeight:function(height){Konva.Node.prototype.setHeight.call(this,height);if(this.outerRadius()!==height/2){this.setOuterRadius(height/2)}}};Konva.Util.extend(Konva.Star,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Star,"numPoints",5);Konva.Factory.addGetterSetter(Konva.Star,"innerRadius",0);Konva.Factory.addGetterSetter(Konva.Star,"outerRadius",0);Konva.Collection.mapMethods(Konva.Star)})();(function(){"use strict";var ATTR_CHANGE_LIST=["fontFamily","fontSize","fontStyle","padding","lineHeight","text"],CHANGE_KONVA="Change.konva",NONE="none",UP="up",RIGHT="right",DOWN="down",LEFT="left",LABEL="Label",attrChangeListLen=ATTR_CHANGE_LIST.length;Konva.Label=function(config){this.____init(config)};Konva.Label.prototype={____init:function(config){var that=this;Konva.Group.call(this,config);this.className=LABEL;this.on("add.konva",function(evt){that._addListeners(evt.child);that._sync()})},getText:function(){return this.find("Text")[0]},getTag:function(){return this.find("Tag")[0]},_addListeners:function(text){var that=this,n;var func=function(){that._sync()};for(n=0;n<attrChangeListLen;n++){text.on(ATTR_CHANGE_LIST[n]+CHANGE_KONVA,func)}},getWidth:function(){return this.getText().getWidth()},getHeight:function(){return this.getText().getHeight()},_sync:function(){var text=this.getText(),tag=this.getTag(),width,height,pointerDirection,pointerWidth,x,y,pointerHeight;if(text&&tag){width=text.getWidth();height=text.getHeight();pointerDirection=tag.getPointerDirection();pointerWidth=tag.getPointerWidth();pointerHeight=tag.getPointerHeight();x=0;y=0;switch(pointerDirection){case UP:x=width/2;y=-1*pointerHeight;break;case RIGHT:x=width+pointerWidth;y=height/2;break;case DOWN:x=width/2;y=height+pointerHeight;break;case LEFT:x=-1*pointerWidth;y=height/2;break}tag.setAttrs({x:-1*x,y:-1*y,width:width,height:height});text.setAttrs({x:-1*x,y:-1*y})}}};Konva.Util.extend(Konva.Label,Konva.Group);Konva.Collection.mapMethods(Konva.Label);Konva.Tag=function(config){this.___init(config)};Konva.Tag.prototype={___init:function(config){Konva.Shape.call(this,config);this.className="Tag";this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var width=this.getWidth(),height=this.getHeight(),pointerDirection=this.getPointerDirection(),pointerWidth=this.getPointerWidth(),pointerHeight=this.getPointerHeight(),cornerRadius=Math.min(this.getCornerRadius(),width/2,height/2);context.beginPath();if(!cornerRadius){context.moveTo(0,0)}else{context.moveTo(cornerRadius,0)}if(pointerDirection===UP){context.lineTo((width-pointerWidth)/2,0);context.lineTo(width/2,-1*pointerHeight);context.lineTo((width+pointerWidth)/2,0)}if(!cornerRadius){context.lineTo(width,0)}else{context.lineTo(width-cornerRadius,0);context.arc(width-cornerRadius,cornerRadius,cornerRadius,Math.PI*3/2,0,false)}if(pointerDirection===RIGHT){context.lineTo(width,(height-pointerHeight)/2);context.lineTo(width+pointerWidth,height/2);context.lineTo(width,(height+pointerHeight)/2)}if(!cornerRadius){context.lineTo(width,height)}else{context.lineTo(width,height-cornerRadius);context.arc(width-cornerRadius,height-cornerRadius,cornerRadius,0,Math.PI/2,false)}if(pointerDirection===DOWN){context.lineTo((width+pointerWidth)/2,height);context.lineTo(width/2,height+pointerHeight);context.lineTo((width-pointerWidth)/2,height)}if(!cornerRadius){context.lineTo(0,height)}else{context.lineTo(cornerRadius,height);context.arc(cornerRadius,height-cornerRadius,cornerRadius,Math.PI/2,Math.PI,false)}if(pointerDirection===LEFT){context.lineTo(0,(height+pointerHeight)/2);context.lineTo(-1*pointerWidth,height/2);context.lineTo(0,(height-pointerHeight)/2)}if(cornerRadius){context.lineTo(0,cornerRadius);context.arc(cornerRadius,cornerRadius,cornerRadius,Math.PI,Math.PI*3/2,false)}context.closePath();context.fillStrokeShape(this)},getSelfRect:function(){var x=0,y=0,pointerWidth=this.getPointerWidth(),pointerHeight=this.getPointerHeight(),direction=this.pointerDirection(),width=this.getWidth(),height=this.getHeight();if(direction===UP){y-=pointerHeight;height+=pointerHeight}else if(direction===DOWN){height+=pointerHeight}else if(direction===LEFT){x-=pointerWidth*1.5;width+=pointerWidth}else if(direction===RIGHT){width+=pointerWidth*1.5}return{x:x,y:y,width:width,height:height}}};Konva.Util.extend(Konva.Tag,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Tag,"pointerDirection",NONE);Konva.Factory.addGetterSetter(Konva.Tag,"pointerWidth",0);Konva.Factory.addGetterSetter(Konva.Tag,"pointerHeight",0);Konva.Factory.addGetterSetter(Konva.Tag,"cornerRadius",0);Konva.Collection.mapMethods(Konva.Tag)})();(function(){"use strict";Konva.Arrow=function(config){this.____init(config)};Konva.Arrow.prototype={____init:function(config){Konva.Line.call(this,config);this.className="Arrow"},_sceneFunc:function(ctx){Konva.Line.prototype._sceneFunc.apply(this,arguments);var PI2=Math.PI*2;var points=this.points();var n=points.length;var dx=points[n-2]-points[n-4];var dy=points[n-1]-points[n-3];var radians=(Math.atan2(dy,dx)+PI2)%PI2;var length=this.pointerLength();var width=this.pointerWidth();ctx.save();ctx.beginPath();ctx.translate(points[n-2],points[n-1]);ctx.rotate(radians);ctx.moveTo(0,0);ctx.lineTo(-length,width/2);ctx.lineTo(-length,-width/2);ctx.closePath();ctx.restore();if(this.pointerAtBeginning()){ctx.save();ctx.translate(points[0],points[1]);dx=points[2]-points[0];dy=points[3]-points[1];ctx.rotate((Math.atan2(-dy,-dx)+PI2)%PI2);ctx.moveTo(0,0);ctx.lineTo(-length,width/2);ctx.lineTo(-length,-width/2);ctx.closePath();ctx.restore()}ctx.fillStrokeShape(this)}};Konva.Util.extend(Konva.Arrow,Konva.Line);Konva.Factory.addGetterSetter(Konva.Arrow,"pointerLength",10);Konva.Factory.addGetterSetter(Konva.Arrow,"pointerWidth",10);Konva.Factory.addGetterSetter(Konva.Arrow,"pointerAtBeginning",false);Konva.Collection.mapMethods(Konva.Arrow)})();