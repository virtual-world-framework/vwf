<html>
<head>
<script>

//starting showing dialog by getting current window.
function ShowOptionsDialog() {
    chrome.windows.getCurrent(onGetWindow);
}

//got current window, getting current tab.
function onGetWindow(win)
{
    chrome.tabs.getSelected(win.id, onGetTab);    
}

//tab found. Here we should tell somehow to content-script that we need to show dialog.
//Note that this code will not work on newly created tabs where no extension contnent-script is loaded.
function onGetTab(tab)
{    
    // send message to content script
    chrome.tabs.getSelected(null, function(tab) {
        if (tab.url.indexOf("chrome://") == 0)
        {
          var skype_plugin = window.parent.document.getElementById("skype_plugin_object");
          if (skype_plugin != null)
          {
               skype_plugin.ShowOptionsDialog();
          }
        }
        else
        {
          chrome.tabs.sendRequest(tab.id, {action: "ShowOptionsDialog"}, function(response) {});
        }
    });   
}

var AutoExtractNumbers     = "AutoExtractNumbers";
var NameHighlighterEnabled = "NameHighlighterEnabled";

// Called when the user clicks on the browser action.
chrome.browserAction.onClicked.addListener(function(tab) { ShowOptionsDialog(); });

if (window.localStorage[AutoExtractNumbers] === undefined)
{
    window.localStorage.setItem(AutoExtractNumbers, "1");	
}
if (window.localStorage[NameHighlighterEnabled] === undefined)
{
    window.localStorage.setItem(NameHighlighterEnabled, "0");	
}
//send highlighting settings from localStorage to contentscript.js
chrome.tabs.getSelected(null, 
    function(tab) 
    {
        chrome.tabs.sendRequest(tab.id, 
        { 
            action : "init",
            numbers: window.localStorage[AutoExtractNumbers],
            names  : window.localStorage[NameHighlighterEnabled]
        },
        function(response) {});
    }
);

// set up an event listener to handle the messages from the contentscript.js
chrome.extension.onRequest.addListener(
    function(request, sender, sendResponse) 
    {
        switch(request.action) 
        {
            case 'set' : 
                window.localStorage[AutoExtractNumbers]     = request.numbers;
                //window.localStorage[NameHighlighterEnabled] = request.names; 
                sendResponse();
                refreshAllSettings();
                break;
            case 'get' :
                sendResponse(
                {
                    numbers: window.localStorage[AutoExtractNumbers],
                    names  : window.localStorage[NameHighlighterEnabled]
                });
                break;
            case 'open_url' :
                chrome.tabs.create({url: request.url, selected: true});
                sendResponse();
                break;
            default:
                sendResponse();
        }
    }
);

//send new settings to all tabs in all windows
function refreshAllSettings()
{
	chrome.windows.getAll({populate:true}, 
	function(windowList)
	{
		windowList.forEach(
		function(w)
		{
			w.tabs.forEach(
			function(t)
			{
			        chrome.tabs.sendRequest(t.id, 
        			{ 
			            action : "refresh",
			            numbers: window.localStorage[AutoExtractNumbers],
			            names  : window.localStorage[NameHighlighterEnabled]
			        },
			        function(response) {});
			});
		});	
	});
};

//Fire onDisconnect event when extension is turned off or removed.
chrome.extension.onConnect.addListener(function(port) {});

</script>
</head>

<body>
<embed id="skype_plugin_object" onBackgroundPage='true' type="application/x-vnd.skype.click2call.chrome.5.6.0"/>
<script>


    // append listener (this listener will open an URL in a new tab
    var skype_plugin = document.getElementById("skype_plugin_object");
    if (skype_plugin)
    skype_plugin.addEventListener('OpenUrl',
                             function(e)
                             { 
                                  chrome.tabs.create({url: e.data, selected: true});
                             });


    var pref_element = document.createElement("span");
    pref_element.setAttribute("id", "skype_highlighting_settings");
    pref_element.setAttribute("display", "none");
    pref_element.setAttribute(AutoExtractNumbers, window.localStorage[AutoExtractNumbers]);
    document.documentElement.appendChild(pref_element);
    pref_element.addEventListener('settingsChanged', function() {window.localStorage[AutoExtractNumbers]=pref_element.getAttribute(AutoExtractNumbers); refreshAllSettings()});
</script>

</body>
</html>

